---
title: '[async/await] ES5ë¡œ ì œë„ˆë ˆì´í„° êµ¬í˜„í•˜ê¸°(2)'
date: '2023-01-23'
lastmod: '2023-01-23'
tags: ['JavaScript', 'async/await']
draft: false
series: ë™ì‘ì›ë¦¬
summary: ì œë„ˆë ˆì´í„°ê°€ ES5 ë¬¸ë²•ìœ¼ë¡œ ì–´ë–»ê²Œ êµ¬í˜„ë˜ì–´ìˆëŠ”ì§€ ë¶„ì„í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” closureì™€ switchë¬¸ ë“±ì„ ì´ìš©í•´ ì–´ë–»ê²Œ ì œë„ˆë ˆì´í„°ì²˜ëŸ¼ ë™ì‘í•˜ë„ë¡ ë§Œë“œëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤.
images: [https://i.imgur.com/YB6XuGM.png]
layout: PostLayout
---

## ë¶„ì„í•˜ê¸° ì•ì„œ
[ì €ë²ˆ í¬ìŠ¤íŠ¸](https://www.timegambit.com/blog/digging/async-await/02)ì—ì„œ ë‹¤ë£¨ì—ˆë˜ ë‚´ìš©ì´ ê¸°ì–µë‚˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë‹¤ì‹œ í•œ ë²ˆ ì½ì–´ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤. ê°„ë‹¨íˆ ìš”ì•½í•˜ê³  ì„¤ëª…ì„ ì‹œì‘í•˜ê² ì§€ë§Œ *ì™œ ì´ëŸ° ê²°ë¡ ì´ì—ˆë”ë¼?* ğŸ¤” í•˜ì‹ ë‹¤ë©´ ì½ëŠ” ì¬ë¯¸ê°€ ë°˜ê°ë  ê±°ì—ìš”!

### ê°ì²´ë“¤ê°„ì˜ ê´€ê³„
![ê°ì²´ë“¤ê°„ì˜ ê´€ê³„ë„](https://i.imgur.com/OGA0FV7.png)

`_regeneratorRuntime`, `mark`, `wrap` í•¨ìˆ˜ë¥¼ ìˆ˜í–‰í•´ê°€ë©´ì„œ ê°ì²´ë“¤ê°„ì˜ ê´€ê³„ëŠ” ìœ„ ê·¸ë¦¼ì²˜ëŸ¼ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê´€ê³„ë“¤ ì¤‘ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ **`generator`ì™€ `Gp`ì˜ ê´€ê³„ì…ë‹ˆë‹¤**. `generator.__proto__.__proto__ === Gp`ë¼ëŠ” ê²ƒì„ ê¸°ì–µí•´ì£¼ì„¸ìš”!

### `asyncGeneratorStep`ì˜ `gen`
```js showLineNumbers
// gen: generator
// key: 'next'
function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  ...
  var info = gen[key](arg);
  ...
}
```
`asyncGeneratorStep` í•¨ìˆ˜ëŠ” `gen`ì´ë¼ëŠ” ì¸ìë¥¼ ë°›ìŠµë‹ˆë‹¤. ì´ `gen`ì€ `_regeneratorRuntime` í•¨ìˆ˜ê°€ ë§Œë“¤ì–´ì¤€ `generator` ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ 5ë²ˆ ë¼ì¸ì—ì„œ `generator.next` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì €ë²ˆ ì„¤ëª…ì—ì„œ `generator` ê°ì²´ì— `next` í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì£¼ì§€ëŠ” ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì´ ë–¡ë°¥ì„ íšŒìˆ˜í•˜ê³ , ë¬´í•œë£¨í”„ì™€ switchë¬¸ì´ ì™œ ìˆì—ˆëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

## `next` í•¨ìˆ˜ëŠ” ì–´ë””ì—?

ì´ ì˜ë¬¸ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì €ë²ˆì— ì„¤ëª…í•  ë•Œì— ìƒëµí–ˆë˜ `_regeneratorRuntime` í•¨ìˆ˜ì˜ ì¼ë¶€ë¥¼ ë‹¤ì‹œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```js showLineNumbers {5}
function _regeneratorRuntime() {
  ...
  return (
    ...
    defineIteratorMethods(Gp),
    ...
  )
}
```

`_regeneratorRuntime` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ë•Œ `Gp`ë¥¼ ì´ˆê¸°í™”í•´ì¤ë‹ˆë‹¤. ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ìƒëµí–ˆì§€ë§Œ `defineIteratorMethods` í•¨ìˆ˜ë¥¼ ì´ìš©í•´, `Gp`ì˜ `constructor`ì™€ `__proto__` ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ê²ƒë“¤ë„ ì´ˆê¸°í™”í•´ì¤ë‹ˆë‹¤. ì´ í•¨ìˆ˜ì—ì„œëŠ” ì–´ë–¤ ê²ƒë“¤ì„ ì„¤ì •í•´ì¤„ê¹Œìš”?

### `defineIteratorMethods` í•¨ìˆ˜
```js showLineNumbers {3-4,11}
function defineIteratorMethods(prototype) {
  ["next", "throw", "return"].forEach(function (method) {
    define(prototype, method, function (arg) {
      return this._invoke(method, arg);
    });
  });
}

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  ...
  var info = gen[key](arg);
  ...
}
```
`defineIteratorMethods` í•¨ìˆ˜ëŠ” `prototype`ì„ ì¸ìë¡œ ë°›ìŠµë‹ˆë‹¤. `prototype`ì€ `Gp`ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤. ì¦‰, `Gp` ê°ì²´ì— `next`, `throw`, `return` ë©”ì†Œë“œë¥¼ ì„¤ì •í•´ì¤ë‹ˆë‹¤. `generator.next` í•¨ìˆ˜ë¥¼ ì–´ë–»ê²Œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ”ì§€ ê°ì´ ì˜¤ì‹œë‚˜ìš”?

![next í•¨ìˆ˜ë¥¼ ì°¾ê¸°ê¹Œì§€](https://i.imgur.com/BpIsRKZ.png)

`generator` ê°ì²´ì—ëŠ” `next` í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— í”„ë¡œí† ì²´ì´ë‹ì„ í†µí•´ `next` í•¨ìˆ˜ë¥¼ ì°¾ì•„ë‚˜ê°‘ë‹ˆë‹¤. ìš°ì„  `generator`ì˜ __proto__ì¸ â“ ê°ì²´ë¥¼ ì°¾ì•„ë´…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ì—ë„ `next` í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ â“ ê°ì²´ì˜ __proto__ì¸ `Gp` ê°ì²´ë¥¼ ì°¾ì•„ë´…ë‹ˆë‹¤. ê·¸ë¦¬ê³  `Gp` ê°ì²´ì—ëŠ” `defineIteratorMethods` í•¨ìˆ˜ë¥¼ í†µí•´ ì„¤ì •í•´ì¤€ `next` í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ìœ„ ì½”ë“œì˜ 11ë²ˆ ë¼ì¸ì„ í†µí•´ `Gp.next` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤! ê·¸ë¦¬ê³  `next` í•¨ìˆ˜ì—ì„œëŠ” `this._invoke` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ ê²°êµ­ `generator._invoke` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤.

<Alert type="info">
  Q. ì–´ë–»ê²Œ `this._invoke`ë¡œ `generator._invoke`ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë‚˜ìš”?

  A. ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ `this`ëŠ” ê½¤ ë‚œí•´í•œ ê°œë…ì´ì£ . ê·¸ë˜ì„œ í—·ê°ˆë¦´ ë•Œê°€ ë§ìŠµë‹ˆë‹¤. ì§€ê¸ˆì²˜ëŸ¼ ê°ì²´ì— ì •ì˜ë˜ì–´ ìˆëŠ” ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ë•Œì— `this`ëŠ” í•´ë‹¹ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œ ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤. ì¦‰, ìœ„ ì½”ë“œì˜ 4ë²ˆ ë¼ì¸ì˜ `this`ëŠ” `generator` ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ 11ë²ˆ ë¼ì¸ì˜ `gen`ì€ `generator` ê°ì²´ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

  ì•„ë˜ ì½”ë“œëŠ” ì§€ê¸ˆê¹Œì§€ì˜ ê³¼ì •ì„ ë§¤ìš° ê°„ë‹¨íˆ ìš”ì•½í•˜ì—¬, ì •ë§ `this`ê°€ `generator` ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸í•´ë³´ëŠ” ì½”ë“œì…ë‹ˆë‹¤. ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”!

  ```js
  const Gp = {};

  function callee() {}

  callee.prototype = Object.create(Gp);

  const generator = Object.create(callee.prototype);

  Object.defineProperty(generator, "_invoke", {
    value: function (method, arg) {
      console.log(this === generator); // true
    },
  });

  Object.defineProperty(Gp, "next", {
    value: function (arg) {
      console.log(this === generator); // true
      return this._invoke("next", arg);
    },
  });

  generator.next();
  ```
</Alert>

## `makeInvokeMethod` í•¨ìˆ˜

ìœ„ì—ì„œ `Gp.next` í•¨ìˆ˜ë¥¼ í†µí•´ `generator._invoke` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•¨ì„ ì•Œê²Œë˜ì—ˆìŠµë‹ˆë‹¤. `generator._invoke` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?

```js showLineNumbers {7-8}
function _regeneratorRuntime() {
  ...
  function wrap(innerFn, outerFn, self, tryLocsList) {
    ...
    context = new Context(tryLocsList || []);
    return (
      defineProperty(generator, "_invoke", {
        value: makeInvokeMethod(innerFn, self, context),
      }),
      generator
    );
  }
  ...
}
```
ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ `generator._invoke` í•¨ìˆ˜ì— `makeInvokeMethod` í•¨ìˆ˜ë¥¼ í†µí•´ ìƒì„±ëœ í•¨ìˆ˜ë¥¼ í• ë‹¹í•´ì¤€ë‹¤ê³  ì„¤ëª…í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ì´ì œ `makeInvokeMethod` í•¨ìˆ˜ë¥¼ ë´ì•¼ê² ë„¤ìš”.

ë³´ëŸ¬ê°€ê¸° ì „ì— `innerFn`ì— `_callee$` í•¨ìˆ˜ê°€ ë‹´ê¸´ë‹¤ëŠ” ê²ƒì„ ë‹¤ì‹œ í•œ ë²ˆ ìƒê¸°í•˜ê³  ê°‘ì‹œë‹¤! (ì™œ `innerFn`ì— `_callee$`ê°€ ë‹´ê¸°ëŠ”ì§€, `_callee$`ê°€ ë¬´ì—‡ì¸ì§€ ê¸°ì–µì´ ì•ˆë‚˜ì‹œë©´ [ì´ì „ í¬ìŠ¤íŠ¸ì˜ wrap ì„¤ëª…](https://timegambit.com/blog/digging/async-await/02#wrap)ì„ ë‹¤ì‹œ ì½ì–´ì£¼ì„¸ìš”!)

```js:makeInvokeMethod() showLineNumbers {5,8,13,20,29}
function makeInvokeMethod(innerFn, self, context) {
  var state = "suspendedStart";
  return function (method, arg) {
    ...
    for (context.method = method, context.arg = arg; ; ) {
      ...
      if ("next" === context.method) {
        context.sent = context._sent = context.arg;
      } else {
        "return" === context.method && context.abrupt("return", context.arg);
      }
      state = "executing";
      var record = tryCatch(innerFn, self, context);
      if ("normal" === record.type) {
        if (
          ((state = context.done ? "completed" : "suspendedYield"),
          record.arg === ContinueSentinel)
        )
          continue;
        return { value: record.arg, done: context.done };
      }
      ...
    }
  };
}

function tryCatch(fn, obj, arg) {
  try {
    return { type: "normal", arg: fn.call(obj, arg) };
  } catch (err) {
    return { type: "throw", arg: err };
  }
}
```

`makeInvokeMethod` í•¨ìˆ˜ì˜ ì¸ìì¸ `innerFn`ì€ `_callee$`ì´ë©° `context`ëŠ” í˜„ì¬ì˜ ì‹¤í–‰í™˜ê²½ì´ ë‹´ê¸°ëŠ” ê°ì²´ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  `makeInvokeMethod` í•¨ìˆ˜ê°€ return í•´ì£¼ëŠ”, 3~24ë²ˆ ë¼ì¸ì— ê±¸ì³ ì •ì˜ëœ í•¨ìˆ˜ê°€ `generator._invoke`ì— ë‹´ê¸°ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.(3\~24ë²ˆ ë¼ì¸ì— ê±¸ì³ ì •ì˜ëœ ì´ í•¨ìˆ˜ë¥¼ `_invoke` í•¨ìˆ˜ë¼ê³  í•˜ê² ìŠµë‹ˆë‹¤.) ê·¸ë˜ì„œ `asyncGeneratorStep` í•¨ìˆ˜ì—ì„œ `gen[key](arg)`ë¥¼ í˜¸ì¶œí•˜ë©´ 3ë²ˆ ë¼ì¸ì˜ `method`ì— `'next'`ê°€ ë‹´ê²¨ í˜¸ì¶œë©ë‹ˆë‹¤. (í˜„ì¬ `arg`ëŠ” undefinedì…ë‹ˆë‹¤.)

5ë²ˆ, 8ë²ˆ ë¼ì¸ì„ `context`ëŠ” \{ method: 'next', arg: undefined, sent: undefined, _sent: undefined, ... \}ì¸ ê°ì²´ê°€ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ `context`ì™€ í•¨ê»˜ `_callee$`(= `innerFn`)ë¥¼ ì¸ìë¡œ ë„£ì–´ `tryCatch` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  `tryCatch` í•¨ìˆ˜ì—ì„œ `fn.call`ì„ í†µí•´ `_callee$`ë¥¼ í˜¸ì¶œí•´ì¤ë‹ˆë‹¤.

<Alert type="info">
  ì¤‘ìš”í•˜ì§€ëŠ” ì•Šì§€ë§Œ `context`ì— ëŒ€í•´ ë¶€ì—°ì„¤ëª…ì„ í•©ë‹ˆë‹¤. `context`ëŠ” `wrap` í•¨ìˆ˜ì—ì„œ `new Context()`ë¥¼ í†µí•´ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ ë•Œ `Context` í•¨ìˆ˜ì—ì„œ ì•„ë˜ ì½”ë“œì˜ `reset` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ `context`ì˜ ì—¬ëŸ¬ ì†ì„±ë“¤ì„ ì´ˆê¸°í™”í•´ì¤ë‹ˆë‹¤.

  ```js
  (Context.prototype = {
    constructor: Context,
      reset: function reset(skipTempReset) {
        if (
          ((this.prev = 0),
          (this.next = 0),
          (this.sent = this._sent = undefined),
          (this.done = !1),
          (this.delegate = null),
          (this.method = "next"),
          (this.arg = undefined),
          this.tryEntries.forEach(resetTryEntry),
          !skipTempReset)
        )
        ...
    }
  },
  ```
</Alert>

## `_callee$`

`generator._invoke`ë¥¼ í˜¸ì¶œí•˜ë©´ `_callee$` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ëœë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œê²Œë˜ì—ˆìŠµë‹ˆë‹¤. ëŒê³  ëŒì•„ ë‹¤ì‹œ `_callee$` í•¨ìˆ˜ë¡œ ëŒì•„ì™”ë„¤ìš”. ì´ë²ˆì—ëŠ” ì´ í•¨ìˆ˜ ì•ˆì— ìˆë˜ ë¬´í•œë£¨í”„ê°€ ë¬´ì—‡ì¸ì§€ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

```js showLineNumbers
function _callee$(_context) {
  while (1) {
    switch ((_context.prev = _context.next)) {
      case 0:
        _context.next = 2;
        return new Promise(function (resolve) {
          return setTimeout(resolve, 1000);
        }).then(function () {
          return 123;
        });
      case 2:
        val = _context.sent;
        _context.next = 5;
        return Promise.resolve(val).then(function (v) {
          return 3 * v;
        });
      case 5:
        return _context.abrupt("return", _context.sent);
      case 6:
      case "end":
        return _context.stop();
    }
  }
}
```

`_context`ì˜ `next`ì™€ `prev`ëŠ” switch ë¬¸ì—ì„œ ë‹¤ìŒì— ìˆ˜í–‰í•´ì•¼í•  ì½”ë“œì™€ ì´ì „ì— ìˆ˜í–‰í•œ ì½”ë“œë¥¼ ê¸°ì–µí•˜ê¸° ìœ„í•´ ì¡´ì¬í•˜ëŠ” ì†ì„±ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ `_context.next`ëŠ” ì²˜ìŒì—ëŠ” 0ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤. (ìœ„ìª½ì˜ ë¶€ì—°ì„¤ëª…ì—ì„œ `_context.next`ê°€ ì²˜ìŒì— 0ìœ¼ë¡œ ì´ˆê¸°í™”ë¨ì„ ì„¤ëª…í–ˆìŠµë‹ˆë‹¤.)

`case 0`ì„ ë³´ë‹ˆ ë‹¤ìŒì—ëŠ” `case 2`ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ `context.next`ë¥¼ 2ë¡œ ë³€ê²½í•´ì£¼ê³ , Promiseë¥¼ return í•´ì£¼ê³  ìˆë„¤ìš”.(ì•„ë§ˆ `_context.next`ê°€ 0, 2, 5, "end"ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ë³€í•˜ë©´ì„œ ì½”ë“œë¥¼ ì°¨ë¡€ëŒ€ë¡œ ì‹¤í–‰í•˜ê² ì£ ?) returnëœ PromiseëŠ” `tryCatch` í•¨ìˆ˜ì—ì„œ returní•´ì£¼ëŠ” ê°ì²´ì˜ `arg`ì— ë‹´ê¸°ê³ , ê²°êµ­ `_invoke` í•¨ìˆ˜ì˜ `record` ë³€ìˆ˜ì— \{ type: 'normal', arg: Promise \}ê°€ ë‹´ê¸°ê²Œ ë©ë‹ˆë‹¤. `record.arg`ì— í• ë‹¹ëœ PromiseëŠ” `_callee$` í•¨ìˆ˜ê°€ returní•´ì£¼ì—ˆë˜ Promiseì…ë‹ˆë‹¤.

```js showLineNumbers {8,15}
function makeInvokeMethod(innerFn, self, context) {
  ...
  return function (method, arg) {
    ...
    var record = tryCatch(innerFn, self, context);
    if ("normal" === record.type) {
      ...
      return { value: record.arg, done: context.done }; // value: Promise, done: false
    }
  };
}

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg); // { value: Promise, done: false }
    var value = info.value;
  }
  ...
  if (info.done) {
    resolve(value);
  } else {
    Promise.resolve(value).then(_next, _throw);
  }
}
```
`record.type`ì€ `normal`ì´ê¸° ë•Œë¬¸ì— `_invoke` í•¨ìˆ˜ëŠ” \{ value: Promise, done: false \}ë¥¼ return í•´ì£¼ê³ , ì´ returnëœ ê°ì²´ëŠ” 15ë²ˆ ë¼ì¸ì˜ `info`ì— ë‹´ê¸°ê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  16ë²ˆ ë¼ì¸ì˜ `value`ëŠ” `_callee$`ê°€ return í•´ì¤€ Promiseê°€ ë˜ì–´ 22ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.

ì ì‹œ ìš°ë¦¬ê°€ `asyncGeneratorStep` í•¨ìˆ˜ê°€ ë˜ì–´ ìƒê°í•´ë´…ì‹œë‹¤. `asyncGeneratorStep` í•¨ìˆ˜ì¸ ìš°ë¦¬ëŠ” `gen`ì´ ì–´ë–»ê²Œ ì´ë£¨ì–´ì ¸ìˆëŠ”ì§€ëŠ” ëª¨ë¥´ê² ìŠµë‹ˆë‹¤ë§Œ, ê·¸ëƒ¥ ì œë„ˆë ˆì´í„°ë¼ê³  ìƒê°í•˜ê³  ì œë„ˆë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì²˜ëŸ¼ ì‚¬ìš©í•˜ë‹ˆê¹Œ ì œë„ˆë ˆì´í„°ì²˜ëŸ¼ ë™ì‘í•˜ê³  ìˆì§€ ì•Šë‚˜ìš”? `generator._invoke()`, `tryCatch()`, `_callee$()`, `context`ê°€ ì ì ˆíˆ ë™ì‘í•˜ì—¬ `asyncGeneratorStep`ì¸ ìš°ë¦¬ì—ê²Œ `gen`ì€ ì œë„ˆë ˆì´í„°ë¼ê³  ìƒê°í•˜ê²Œ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤! `outerFn` í•¨ìˆ˜ì˜ 2ë²ˆì§¸ Promiseê¹Œì§€ `_context.next`ë¥¼ ë°”ê¿”ê°€ë©° ìˆœì°¨ì ìœ¼ë¡œ ì œë„ˆë ˆì´í„°ì²˜ëŸ¼ ë™ì‘í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ yield í‚¤ì›Œë“œë¡œ ê°’ì„ ë„˜ê²¨ì£¼ëŠ” ë¶€ë¶„ê³¼ ì œë„ˆë ˆì´í„°ì˜ ì¢…ë£ŒëŠ” ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ”ì§€ ë§ˆì €ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## yieldë¡œ ê°’ ë„˜ê²¨ì£¼ê¸°ëŠ” ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?
`_callee$`ì˜ ì²« Promiseì—ì„œ 123ì´ ë‚˜ì˜¤ë¯€ë¡œ [async/await ë™ì‘ì›ë¦¬ 1í¸](https://www.timegambit.com/blog/digging/async-await/01)ì—ì„œ ì„¤ëª…í–ˆë˜ ê²ƒì²˜ëŸ¼ `arg`ê°€ 123ì´ ë˜ì–´ `asyncGeneratorStep` í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ë”°ë¼ì„œ `generator.next(123)`ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

```js showLineNumbers {8,22}
function makeInvokeMethod(innerFn, self, context) {
  ...
  return function (method, arg) {
    ...
    for (context.method = method, context.arg = arg; ; ) {
      ...
      if ("next" === context.method) {
        context.sent = context._sent = context.arg;
      }
      ...
      var record = tryCatch(innerFn, self, context);
      ...
    }
  };
}

function _callee$(_context) {
  while (1) {
    switch ((_context.prev = _context.next)) {
      ...
      case 2:
        val = _context.sent;
        _context.next = 5;
        return Promise.resolve(val).then(function (v) {
          return 3 * v;
        });
      ...
    }
  }
}
```

`generator.next(123)`ì€ `_invoke`í•¨ìˆ˜ì˜ `arg`ì— 123ì„ ë„£ì–´ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ 8ë²ˆ ë¼ì¸ì—ì„œ `context.sent`ì— 123ì´ ë‹´ê¸°ê²Œ ë˜ê³ , `tryCatch()` â†’ `_callee$()`ë¥¼ ê±°ì³ê°€ë©° 22ë²ˆ ë¼ì¸ì—ì„œ `val`ì— 123ì„ ë‹´ê²Œ ë©ë‹ˆë‹¤. ë§ˆì¹˜ `yield` í‚¤ì›Œë“œë¥¼ í†µí•´ ê°’ì„ ë„˜ê²¨ì¤€ ê²ƒì²˜ëŸ¼ ë§ì´ì£ .

## ì œë„ˆë ˆì´í„° ì¢…ë£ŒëŠ” ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?

```js showLineNumbers {3,5,12,13,18,26-29,42,44}
(Context.prototype = {
  stop: function stop() {
    this.done = !0;
    ...
    return this.rval;
  },
  ...
  abrupt: function abrupt(type, arg) {
    ...
    var record = finallyEntry ? finallyEntry.completion : {}; // finallyEntryëŠ” undefined ì…ë‹ˆë‹¤
    return (
      (record.type = type),
      (record.arg = arg),
      finallyEntry
        ? ((this.method = "next"),
          (this.next = finallyEntry.finallyLoc),
          ContinueSentinel)
        : this.complete(record)
    );
  },
  complete: function complete(record, afterLoc) {
    if ("throw" === record.type) throw record.arg;
    return (
      "break" === record.type || "continue" === record.type
        ? (this.next = record.arg)
        : "return" === record.type
        ? ((this.rval = this.arg = record.arg),
          (this.method = "return"),
          (this.next = "end"))
        : "normal" === record.type && afterLoc && (this.next = afterLoc),
      ContinueSentinel
    );
  },
  ...
}

function _callee$(_context) {
  while (1) {
    switch ((_context.prev = _context.next)) {
      ...
      case 5:
        return _context.abrupt("return", _context.sent);
      case "end":
        return _context.stop();
    }
  }
}
```
42ë²ˆ ë¼ì¸ì—ì„œ `type`ì„ `"return"`ìœ¼ë¡œ, `_context.sent`ëŠ” 369ì´ë¯€ë¡œ `arg`ë¥¼ 369ë¡œ í•˜ì—¬ 8ë²ˆ ë¼ì¸ì˜ `Context.abrupt` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  12~13ë²ˆ ë¼ì¸ì—ì„œ `abrupt` í•¨ìˆ˜ì˜ `record`ë¥¼ \{ type: 'return', arg: 369 \}ë¡œ ë§Œë“¤ì–´ `complete` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. `complete` í•¨ìˆ˜ì—ì„œëŠ” `this.rval`ì— 369, `this.next`ì— `'end'`ë¥¼ ì„¤ì •í•´ì¤ë‹ˆë‹¤. `complete` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì¤€ ê°ì²´ëŠ” `_context`ì´ë¯€ë¡œ, `_context` ê°ì²´ëŠ” \{ rval: 369, next: 'end', ... \} ê°€ ë©ë‹ˆë‹¤. ì´í›„ì— `_callee$` í•¨ìˆ˜ê°€ ë‹¤ì‹œ í•œ ë²ˆ í˜¸ì¶œë˜ë©´ `_context.stop` í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ 3ë²ˆë¼ì¸ì„ í†µí•´ `_context`ëŠ” \{ done: true, rval: 369, ... \}ê°€ ë˜ë©°, 5ë²ˆ ë¼ì¸ì—ì„œ returní•´ì¤€ 369(= `this.rval`)ë¥¼ `_callee$` ê°€ returní•˜ê²Œ ë©ë‹ˆë‹¤.

```js showLineNumbers {5,12,17}
function makeInvokeMethod(innerFn, self, context) {
  ...
  return function (method, arg) {
    ...
    return { value: record.arg, done: context.done }; // value: 369, done: true
    ...
  };
}

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg); // { value: 369, done: true }
    var value = info.value;
  }
  ...
  if (info.done) {
    resolve(value);
  }
  ...
}
```
`_context.complete`, `_context.stop` í•¨ìˆ˜ë¥¼ í†µí•´ ì„¤ì •ëœ ê°’ë“¤ë¡œ ì¸í•´ `_invoke` í•¨ìˆ˜ëŠ” \{ value: 369, done: true \}ë¥¼ return í•˜ê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  17ë²ˆ ë¼ì¸ì—ì„œ `resolve(369)`ê°€ í˜¸ì¶œë˜ì–´ ê²°êµ­ `outerFn`ì˜ `then`ì„ í†µí•´ ë“±ë¡ëœ `(val) => console.log(val)`ì´ ìˆ˜í–‰ë˜ì–´ 369ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.

## ë§ˆë¬´ë¦¬
ì§€ê¸ˆê¹Œì§€ ES5 ë¬¸ë²•ìœ¼ë¡œ ì œë„ˆë ˆì´í„°ë¥¼ ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ”ì§€ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤. ì¢€ ì–´ë ¤ì› ë‚˜ìš”? ì €ë„ ë¶„ì„ì„ ì–¼ë§ˆë‚˜ ì˜¤ë«ë™ì•ˆ í˜ë“¤ê²Œ í–ˆëŠ”ì§€ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤... í•˜ì§€ë§Œ ê·¸ ì´ìƒìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” ê²ƒì´ ì˜¤ë˜ê±¸ë¦¬ê³  ì–´ë ¤ì› ìŠµë‹ˆë‹¤. ìµœëŒ€í•œ ì´ ê¸€ì„ ì½ëŠ” ëª¨ë“  ì‚¬ëŒë“¤ì´ ì´í•´í•  ìˆ˜ ìˆë„ë¡ í•„ìš”í•œ ë‚´ìš©ì„ ëª¨ë‘ ë‹¤ë£¨ë ¤ê³  ë…¸ë ¥í–ˆìŠµë‹ˆë‹¤. í˜ë“¤ê²Œ ë¶„ì„í•˜ê³  ì–´ë µê²Œ ì‘ì„±í•œë§Œí¼, ì´ ê¸€ì„ ì½ì–´ì£¼ì‹œëŠ” ëª¨ë“  ë¶„ë“¤ì´ ì´í•´í•  ìˆ˜ ìˆìœ¼ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.ğŸ™ƒ ë§Œì•½ ì´í•´ê°€ ê°€ì§€ ì•ŠëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”!

**ì˜¤íƒ€ ë° ì˜¤ë¥˜ ì§€ì ì€ ì–¸ì œë‚˜ í™˜ì˜ì…ë‹ˆë‹¤!**
