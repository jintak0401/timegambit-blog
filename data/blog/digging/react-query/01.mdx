---
title: '[React Query] useQuery ë™ì‘ì›ë¦¬(1)'
date: '2023-02-09'
lastmod: '2023-02-09'
tags: ['React Query','ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶„ì„']
draft: false
series: ë™ì‘ì›ë¦¬
summary: Tanstack Query(React Query)ì˜ useQueryì˜ ë™ì‘ì›ë¦¬ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤. ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì¤‘ìš”í•œ ê°ì²´ë“¤ê°„ì˜ ê´€ê³„ì™€ QueryObserverì˜ ìƒì„±ì— ëŒ€í•´ ë‹¤ë£¹ë‹ˆë‹¤.
images: [https://i.imgur.com/OYRQCRi.png]
layout: PostLayout
---

## ë¶„ì„í•˜ê¸° ì•ì„œ

ì´ í¬ìŠ¤íŠ¸ëŠ” React Queryë¥¼ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ ì ì€ ê¸€ì´ ì•„ë‹™ë‹ˆë‹¤. React Queryê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–»ê²Œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€ ì†ŒìŠ¤ì½”ë“œë¥¼ ë¶„ì„í•œ ê¸€ì…ë‹ˆë‹¤. ì•ìœ¼ë¡œ ì—¬ëŸ¬ í¸ì— ê±¸ì³ì„œ React Queryì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ë¶„ì„í•  ê²ƒì…ë‹ˆë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ëŠ” ê·¸ ì¤‘ì—ì„œ useQueryë¥¼ ë¶„ì„í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

```
@tanstack
  â”œâ”€â”€ query-core
  â”‚     â”œâ”€â”€ notifyManager.ts
  â”‚     â”œâ”€â”€ query.ts
  â”‚     â”œâ”€â”€ queryCache.ts
  â”‚     â”œâ”€â”€ queryClient.ts
  â”‚     â”œâ”€â”€ subscribable.ts
  â”‚     â””â”€â”€ queryObserver.ts
  â”‚
  â””â”€â”€ react-query
        â”œâ”€â”€ useBaseQuery.ts
        â””â”€â”€ useQuery.ts
```

react queryë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `yarn add @tanstack/react-query`ë¥¼ í•˜ë©´ @tanstack í´ë” ì•ˆì— query-coreì™€ react-queryê°€ ì„¤ì¹˜ë©ë‹ˆë‹¤. query-core í´ë”ì—ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ í•µì‹¬ ê¸°ëŠ¥ë“¤ì— ëŒ€í•œ ì½”ë“œê°€ ì‘ì„±ë˜ì–´ ìˆê³ , react-query í´ë”ì—ëŠ” query-coreì˜ ì½”ë“œë“¤ì„ ë¦¬ì•¡íŠ¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í›…ìœ¼ë¡œ ë§Œë“¤ì–´ì¤€ ì½”ë“œ ë“±ì´ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.

ìœ„ì˜ êµ¬ì¡°ëŠ” ì˜¤ëŠ˜ ë¶„ì„ì—ì„œ í•µì‹¬ì ìœ¼ë¡œ ë‹¤ë£¨ê²Œ ë  íŒŒì¼ë“¤ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ë¶„ì„ì„ ì‹œì‘í•´ë³´ê² ìŠµë‹ˆë‹¤. (@tanstack/react-query 4.24.4 ë²„ì „ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.)

## 4ê°œì˜ ì£¼ìš” ê°ì²´ì™€ + Î±

ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ ê³„ì†í•´ì„œ ì–¸ê¸‰ë  4ê°œì˜ ê°ì²´ê°€ ìˆìŠµë‹ˆë‹¤. `QueryClient`, `QueryCache`, `Query`, `QueryObserver`ê°€ ê·¸ê²ƒë“¤ì…ë‹ˆë‹¤. ìš°ì„  ì´ ê°ì²´ë“¤ì´ ì–´ë–¤ ê´€ê³„ì¸ì§€ë¶€í„° ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

### QueryClient

```tsx:_app.tsx {6,9}
import { QueryClient } from '@tanstack/query-core';
import { QueryClientProvider } from '@tanstack/react-query';
import type { AppProps } from 'next/app';

export default function App({ Component, pageProps }: AppProps) {
  const queryClient = new QueryClient();

  return (
    <QueryClientProvider client={queryClient}>
      <Component {...pageProps} />
    </QueryClientProvider>
  );
}
```

```ts:queryClient.ts {6}
export class QueryClient {
  private queryCache: QueryCache
  ...

  constructor(config: QueryClientConfig = {}) {
    this.queryCache = config.queryCache || new QueryCache()
    ...
  }
```

`QueryClient`ëŠ” context apië¥¼ í†µí•´ ì „ì—­ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°ì²´ì…ë‹ˆë‹¤. í”„ë¡œì íŠ¸ì—ì„œ ì—¬ëŸ¬ê°œì˜ Providerë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤ë©´ 1ê°œë§Œ ì¡´ì¬í•˜ê²Œ ë©ë‹ˆë‹¤.

### QueryCache

```ts:QueryCache.ts {16-17}
export class QueryCache extends Subscribable<QueryCacheListener> {
  config: QueryCacheConfig

  private queries: Query<any, any, any, any>[]
  private queriesMap: QueryHashMap

  constructor(config?: QueryCacheConfig) {
    super()
    this.config = config || {}
    this.queries = []
    this.queriesMap = {}
  }
  ...
  add(query: Query<any, any, any, any>): void {
    if (!this.queriesMap[query.queryHash]) {
      this.queriesMap[query.queryHash] = query
      this.queries.push(query)
      this.notify({
        type: 'added',
        query,
      })
    }
  }
  ...
}
```

`QueryCache`ëŠ” `queries` ë°°ì—´ê³¼ `queriesMap` ê°ì²´ì— `Query` ê°ì²´ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤. ìœ„ ì½”ë“œì—ì„œ ìƒëµë˜ì—ˆì§€ë§Œ `useQuery`ì˜ ì¸ìë¡œ ë„˜ê²¨ì¤€ keyê°’ì„ ì´ìš©í•´ `queriesMap` ê°ì²´ì˜ valueë¡œ `Query` ê°ì²´ê°€ ì €ì¥ë˜ì–´, ì´ë²ˆ ìš”ì²­ì´ ì´ì „ì— ë“¤ì–´ì˜¨ ìš”ì²­ê³¼ ë™ì¼í•œ ìš”ì²­ì¸ì§€ë¥¼ íŒë‹¨í•œë‹¤ëŠ” ì  ê¸°ì–µí•´ì£¼ì„¸ìš”.

### Query

```ts:query.ts {7-9} showLineNumbers
export class Query<...> extends Removable {
  ...

  constructor(config: QueryConfig<TQueryFnData, TError, TData, TQueryKey>) {
    super()
    ...
    this.observers = []
    this.cache = config.cache
    this.state = this.initialState
    ...
  }
  ...
}
```

`Query` ê°ì²´ëŠ” ìì‹ ì„ ê°€ì§€ê³  ìˆëŠ” `QueryCache`ì™€ ìì‹ ì˜ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ í˜¸ì¶œí•  ì˜µì €ë²„ë“¤ì„ ê°€ì§‘ë‹ˆë‹¤. êµ¬ë…ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ `this.observers`ì— ì˜µì €ë²„ê°€ ì¶”ê°€ë˜ì–´, ìƒíƒœê°€ ë³€ê²½ë˜ë©´ ë“±ë¡ëœ ì˜µì €ë²„ë“¤ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

`this.state`ì—ëŠ” `data`, `isLoading`, `isFetching` ë“± `useQuery`ë¥¼ í†µí•´ ì–»ì„ ìˆ˜ ìˆëŠ” ì •ë³´ë“¤ì´ ë‹´ê²¨ìˆìŠµë‹ˆë‹¤.

### QueryObserver

```ts:QueryObserver.ts showLineNumbers {9,11,17,33}
export class QueryObserver<...> extends Subscribable<QueryObserverListener<TData, TError>> {
  ...
  constructor(
    client: QueryClient,
    options: QueryObserverOptions<...>
  ) {
    super()

    this.client = client
    ...
    this.trackedProps = new Set()
    ...
  }
  ...
  protected onSubscribe(): void {
    if (this.listeners.length === 1) {
      this.currentQuery.addObserver(this)

      if (shouldFetchOnMount(this.currentQuery, this.options)) {
        this.executeFetch()
      }
      ...
    }
  }
  ...
  private updateQuery(): void {
    const query = this.client.getQueryCache().build(this.client, this.options)

    if (query === this.currentQuery) {
      return
    }

    this.currentQuery = query
    ...
  }
}
```

`QueryObserver` ê°ì²´ëŠ” `QueryClient`ì™€ `Query` ê°ì²´ë¥¼ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤(9, 33ë²ˆ ë¼ì¸). 11ë²ˆ ë¼ì¸ì˜ `trackedProps`ëŠ” ê½¤ë‚˜ ì¬ë°ŒëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ìš°ë¦¬ê°€ ì–´ë–¤ ìƒíƒœë“¤ì„ ìš”ì²­í–ˆëŠ”ì§€ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤. ì´ ë¶€ë¶„ì„ ë‹¤ë£° ë•Œ ìì„¸íˆ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ìœ„ì—ì„œ ì„¤ëª…í–ˆë‹¤ì‹œí”¼ êµ¬ë… ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, `Query` ê°ì²´ì— ì˜µì €ë²„ë¡œ `QueryObserver`ê°€ ë“±ë¡ë©ë‹ˆë‹¤(17ë²ˆ ë¼ì¸).

### ì •ë¦¬

![ê°ì²´ê°„ì˜ ê´€ê³„](https://i.imgur.com/V8JiWvn.png)

* `QueryClient`ëŠ” í•˜ë‚˜ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.^[ì¶”ê°€ì ìœ¼ë¡œ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ë©´ í”„ë¡œì íŠ¸ì— ì—¬ëŸ¬ê°œê°€ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ë§Œ, ì—¬ê¸°ì—ì„œëŠ” ìµœìƒìœ„ì— í•˜ë‚˜ë§Œ ìƒì„±í•˜ì˜€ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.] `QueryClient`ê°€ ìƒì„±ë  ë•Œ `QueryCache`ë¥¼ ìƒˆë¡œ ìƒì„±í•˜ì—¬ `this.queryCache`ì— ì €ì¥í•©ë‹ˆë‹¤.
* `QueryCache`ëŠ” `Query` ê°ì²´ê°€ ìƒˆë¡œ ìƒì„±ë  ë•Œë§ˆë‹¤ `queriesMap`ê³¼ `queries`ì— ì €ì¥í•©ë‹ˆë‹¤.
* `Query`ëŠ” ìƒì„±ë  ë•Œ ìì‹ ì„ ì†Œìœ í•œ `QueryCache`ë¥¼ `this.cache`ì— ì €ì¥í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  `QueryObserver.onSubscribe()` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë©´(êµ¬ë…ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´), `Query.observers` ë°°ì—´ì— ì˜µì €ë²„ë¡œ `QueryObserver`ê°€ ë“±ë¡ë©ë‹ˆë‹¤.
* `QueryObserver`ëŠ” ìƒì„±ë  ë•Œ `QueryClient`ë¥¼ `this.client`ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ì „ì— ê°–ê³  ìˆë˜ ì¿¼ë¦¬ê°€ ì—†ê±°ë‚˜ ì¿¼ë¦¬ê°€ ìƒˆë¡œ ì—…ë°ì´íŠ¸ ë˜ë©´, `this.query`ë¥¼ ìµœì‹ í™”ì‹œí‚µë‹ˆë‹¤.

ìœ„ ê·¸ë¦¼ì€ 4ê°œì˜ ê°ì²´ì˜ ê´€ê³„ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ ë‚˜íƒ€ë‚¸ ê²ƒì…ë‹ˆë‹¤. ëª¨ë“  ê´€ê³„ê°€ ì¤‘ìš”í•˜ì§€ë§Œ, íŠ¹íˆ ì£¼ëª©í•´ì„œ ë´ì•¼í•  ì ì€ `Query` ê°ì²´ì™€ `QueryObserver`ì˜ ê´€ê³„ì…ë‹ˆë‹¤. `useQuery`ë¥¼ ì‚¬ìš©í•  ë•Œ ê°™ì€ keyë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ë™ì¼í•œ `Query`ë¥¼ ì—¬ëŸ¬ê°œì˜ `QueryObserver`ë“¤ì´ ê³µìœ í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ Queryë¥¼ ê³µìœ í•¨ìœ¼ë¡œì¨ ì´ì „ì— ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì‹¤í–‰í–ˆë‹¤ë©´ ì¶”ê°€ì ìœ¼ë¡œ ì‹¤í–‰í•˜ì§€ ì•Šê²Œ ë§Œë“¤ë©°, ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œ ë“±ë¡ë˜ì–´ ìˆë˜ ì˜µì €ë²„ë“¤ì„ í˜¸ì¶œí•˜ì—¬ ë¦¬ë Œë”ë§ì„ ë°œìƒì‹œí‚µë‹ˆë‹¤.

### + Î±: NotifyManager

```ts:notifyManager.ts {18,22,26,30}
...
type NotifyCallback = () => void

type NotifyFunction = (callback: () => void) => void

type BatchNotifyFunction = (callback: () => void) => void

export function createNotifyManager() {
  let queue: NotifyCallback[] = []
  let transactions = 0
  let notifyFn: NotifyFunction = (callback) => {
    callback()
  }
  let batchNotifyFn: BatchNotifyFunction = (callback: () => void) => {
    callback()
  }

  const batch = <T>(callback: () => T): T => {
    ...
  }

  const schedule = (callback: NotifyCallback): void => {
    ...
  }

  const batchCalls = <T extends Function>(callback: T): T => {
    ...
  }

  const flush = (): void => {
    ...
  }
  ...
  return {
    batch,
    batchCalls,
    schedule,
    ...
  } as const
}

// SINGLETON
export const notifyManager = createNotifyManager()
```

`notifyManager`ëŠ” Singletonìœ¼ë¡œ ê´€ë¦¬ë˜ëŠ” ê°ì²´ì…ë‹ˆë‹¤. ìœ„ì—ì„œ ì†Œê°œí•œ 4ê°œì˜ ê°ì²´ê°€, íŠ¹íˆ `Query`, `QueryCache`, `QueryObserver`ê°€ notifyManagerë¥¼ ì´ìš©í•´ ìƒíƒœë³€ê²½, ì˜µì €ë²„ ì¶”ê°€ ë“±ì˜ ì´ë²¤íŠ¸ë¥¼ ì„œë¡œì—ê²Œ ì•Œë ¤ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. ë˜, notifyManager ë‚´ë¶€ì—ì„œ ê° ì»´í¬ë„ŒíŠ¸ ë¦¬ë Œë”ë§ì´ ìµœëŒ€í•œ ë™ì‹œì— ì¼ì–´ë‚  ìˆ˜ ìˆë„ë¡ ë‚˜ë¦„ì˜ batch ê¸°ëŠ¥ë„ êµ¬í˜„í•´ë†“ì•˜ìŠµë‹ˆë‹¤. ì´ ë˜í•œ ë’¤ì—ì„œ ë” ìì„¸íˆ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤.

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ ë¶„ì„í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤!

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
project
  â”œâ”€â”€ components
  â”‚     â”œâ”€â”€ component1.tsx
  â”‚     â””â”€â”€ component2.tsx
  â”‚
  â””â”€â”€ pages
        â”œâ”€â”€ _app.tsx
        â””â”€â”€ index.tsx
```

```tsx:components/component1.tsx
import axios from 'axios';
import { useQuery } from '@tanstack/react-query';

// Component2 ë™ì¼
const Component1 = () => {
  const { isLoading, error, data, isFetching } = useQuery({
    queryKey: ['repoData'],
    queryFn: () =>
      axios
        .get('https://api.github.com/repos/tannerlinsley/react-query')
        .then((res) => {
          return res.data;
        }),
  });

  if (isLoading) return <div>Loading...</div>;

  if (error) return <div>An error has occurred: + {error.message}</div>;

  return (
    <div>
      <h1>{data.name}</h1>
      <p>{data.description}</p>
      <strong>ğŸ‘€ {data.subscribers_count}</strong>{' '}
      <strong>âœ¨ {data.stargazers_count}</strong>{' '}
      <strong>ğŸ´ {data.forks_count}</strong>
      <div>{isFetching ? 'Updating...' : ''}</div>
    </div>
  );
};

export default Component1;
```

```tsx:pages/index.tsx
import Component1 from '@/components/component1';
import Component2 from '@/components/component2';

export default function Home() {
  return (
    <div>
      <Component1 />
      <Component2 />
    </div>
  );
}
```

ìœ„ì™€ ê°™ì€ êµ¬ì¡°ì˜ Next JS í”„ë¡œì íŠ¸ì—ì„œ React Queryë¥¼ ì‚¬ìš©í•œë‹¤ê³  í•˜ê² ìŠµë‹ˆë‹¤. `Component`ì˜ ì½”ë“œëŠ” React Queryì˜ ê³µì‹ë¬¸ì„œì—ì„œ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¨ ì½”ë“œì…ë‹ˆë‹¤. `_app.tsx`ëŠ” [QueryClient](#queryclient)ì—ì„œ ì„¤ëª…í•œ ê²ƒê³¼ ë™ì¼í•©ë‹ˆë‹¤. Next JSê°€ ìµìˆ™í•˜ì§€ ì•Šìœ¼ì‹  ë¶„ë“¤ì€, ê·¸ëƒ¥ ìµœìƒìœ„ì—ì„œ React Query Providerë¥¼ ì ì ˆíˆ ì„¤ì •í•´ì£¼ê³ , ì„œë¡œë‹¤ë¥¸ 2ê°œì˜ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë™ì¼í•œ keyì˜ `useQuery`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

## useQueryì™€ useBaseQuery

### useQuery

```ts:useQuery.ts showLineNumbers {13-14}
export function useQuery<
  TQueryFnData,
  TError,
  TData = TQueryFnData,
  TQueryKey extends QueryKey = QueryKey,
>(
  arg1: TQueryKey | UseQueryOptions<TQueryFnData, TError, TData, TQueryKey>,
  arg2?:
    | QueryFunction<TQueryFnData, TQueryKey>
    | UseQueryOptions<TQueryFnData, TError, TData, TQueryKey>,
  arg3?: UseQueryOptions<TQueryFnData, TError, TData, TQueryKey>,
): UseQueryResult<TData, TError> {
  const parsedOptions = parseQueryArgs(arg1, arg2, arg3)
  return useBaseQuery(parsedOptions, QueryObserver)
}
```

`useQuery`ì—ì„œ í¬ê²Œ ì¤‘ìš”í•œ ë‚´ìš©ì€ ì—†ìŠµë‹ˆë‹¤. 13ë²ˆ ë¼ì¸ì˜ `parseQueryArgs()` í•¨ìˆ˜ë¥¼ ì´ìš©í•´ \{ queryKey: ['repoData'], queryFn: () => ... \} í˜•íƒœì˜ `parsedOptions`ë¥¼ ë§Œë“¤ê³ , 14ë²ˆ ë¼ì¸ì˜ `useBaseQuery()` í•¨ìˆ˜ì— `parsedOptions`ì™€ `QueryObserver` í´ë˜ìŠ¤ë¥¼ ë„˜ê²¨ì£¼ê³  í˜¸ì¶œí•˜ë©° return í•´ì£¼ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰, `useQuery()` í•¨ìˆ˜ëŠ” ì¸ìë“¤ì„ íŒŒì‹±í•´ì£¼ê³  ì¤‘ìš”í•œ ë™ì‘ë“¤ì„ í•´ì£¼ëŠ” `useBaseQuery()`ë¥¼ í˜¸ì¶œí•˜ì—¬ return í•´ì£¼ëŠ” ì—­í•  ë¿ì…ë‹ˆë‹¤.

### useBaseQuery

```ts:useBaseQuery.ts showLineNumbers {5,11-14,17,24,34}
export function useBaseQuery<...>(
  options: UseBaseQueryOptions<...>,
  Observer: typeof QueryObserver,
) {
  const queryClient = useQueryClient({ context: options.context })
  const defaultedOptions = queryClient.defaultQueryOptions(options)
  ...

  const [observer] = React.useState(
    () =>
      new Observer<TQueryFnData, TError, TData, TQueryData, TQueryKey>(
        queryClient,
        defaultedOptions,
      ),
  )

  const result = observer.getOptimisticResult(defaultedOptions)

  useSyncExternalStore(
    React.useCallback(
      (onStoreChange) =>
        isRestoring
          ? () => undefined
          : observer.subscribe(notifyManager.batchCalls(onStoreChange)),
      [observer, isRestoring],
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult(),
  )

  ...

  return !defaultedOptions.notifyOnChangeProps
    ? observer.trackResult(result)
    : result
}
```

ì •ë§ ì¤‘ìš”í•œ ë¶€ë¶„ì´ ë§ì€ `useBaseQuery`ì…ë‹ˆë‹¤. ë¨¼ì € 5ë²ˆ ë¼ì¸ì—ì„œ Providerë¥¼ í†µí•´ ì „ë‹¬ë°›ì€ `queryClient`ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ê·¸ë¦¬ê³  11~14ë²ˆ ë¼ì¸ì—ì„œ ìƒˆë¡œìš´ `QueryObserver`ë¥¼ `useState`ë¥¼ í†µí•´ ìƒì„±í•´ì¤ë‹ˆë‹¤. ì•„ë§ˆ ì´ë ‡ê²Œ ìƒê°í•˜ì‹œëŠ” ë¶„ì´ ê³„ì‹¤ê²ë‹ˆë‹¤. *ì™œ setStateëŠ” ì—†ì§€? ê·¸ëŸ¬ë©´ ë¦¬ë Œë”ë§ì„ ì–´ë–»ê²Œ ì‹œí‚¤ëŠ”ê±°ì•¼?* ì´ ì§ˆë¬¸ì— ëŒ€í•œ í•´ë‹µì€ 24ë²ˆ ë¼ì¸ì— ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¼ë‹¨ `QueryObserver`ê°€ ìƒì„±ë  ë•Œ ì–´ë–¤ ì¼ë“¤ì´ ë²Œì–´ì§€ë‚˜ ë¨¼ì €ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## QueryObserver ìƒì„±

```ts:QueryObserver.ts showLineNumbers {13}
export class QueryObserver<...> extends Subscribable<QueryObserverListener<TData, TError>> {
  ...
  constructor(
    client: QueryClient,
    options: QueryObserverOptions<...>
  ) {
    super()

    this.client = client
    this.options = options
    this.trackedProps = new Set()
    ...
    this.setOptions(options)
  }
  ...
}
```
ìœ„ì—ì„œ `client`ì™€ `trackedProps` ì´ì•¼ê¸°ëŠ” í–ˆìœ¼ë‹ˆ ì´ë²ˆì—ëŠ” 13ë²ˆ ë¼ì¸ì˜ `setOptions()` í•¨ìˆ˜ë¥¼ ë³´ê² ìŠµë‹ˆë‹¤.

```ts:QueryObserver.setOptions() showLineNumbers {6,8}
setOptions(
  options?: QueryObserverOptions<...>,
  notifyOptions?: NotifyOptions,
): void {
  ...
  this.updateQuery()
  ...
  this.updateResult(notifyOptions)
  ...
}
```

ì´ í•¨ìˆ˜ì—ì„œ ì—¬ëŸ¬ ë™ì‘ì„ í•˜ì§€ë§Œ ê°€ì¥ ì¤‘ìš”í•œ ë™ì‘ì€ 6ë²ˆ ë¼ì¸ì˜ `updateQuery()` í•¨ìˆ˜ì™€ 8ë²ˆ ë¼ì¸ì˜ `updateResult()` í•¨ìˆ˜ì…ë‹ˆë‹¤. ì§€ê¸ˆ ìƒíƒœë¥¼ ì ì‹œ ìƒê°í•´ë³´ê² ìŠµë‹ˆë‹¤. `QueryClient`ê°€ context apië¥¼ ìœ„í•œ Providerì— ë„£ì–´ì£¼ê¸° ìœ„í•´ ìƒì„±ë˜ì—ˆê³  ì´ì™€ í•¨ê»˜ `QueryCache`ë„ ìƒì„±ëœ ìƒíƒœì…ë‹ˆë‹¤. `QueryObserver`ëŠ” ì§€ê¸ˆ ë§‰ ìƒì„±ë˜ì—ˆì§€ë§Œ ì•„ì§ `Query`ëŠ” ìƒì„±ë˜ì§€ ì•Šì€ ìƒíƒœì£ . ê·¸ë ‡ê¸° ë•Œë¬¸ì— `QueryObserver`ë„ ì•„ì§ `Query`ë¥¼ ê°€ì§€ì§€ ëª»í•œ ìƒíƒœì…ë‹ˆë‹¤. `Query`ê°€ ì•„ì§ ë§Œë“¤ì–´ì§€ì§€ ì•Šì•˜ìœ¼ë‹ˆê¹Œìš”.

![í˜„ì¬ ìƒíƒœ](https://i.imgur.com/68eVy7c.png)

6ë²ˆ ë¼ì¸ì˜ `updateQuery()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•¨ìœ¼ë¡œì¨ `Query`ë„ ìƒì„±í•˜ê³ , `QueryCache`ì—ë„ í•´ë‹¹ `Query`ë¥¼ ë„£ì–´ì£¼ë©°, ì§€ê¸ˆ ìƒì„± ì¤‘ì¸ `QueryObserver`ë„ í•´ë‹¹ `Query` ê°ì²´ë¥¼ ê°€ì§€ê²Œ í•´ì¤ë‹ˆë‹¤.

### updateQuery()

```ts:QueryObserver.updateQuery() showLineNumbers {2,11}
private updateQuery(): void {
  const query = this.client.getQueryCache().build(this.client, this.options)

  if (query === this.currentQuery) {
    return
  }

  const prevQuery = this.currentQuery as
    | Query<TQueryFnData, TError, TQueryData, TQueryKey>
    | undefined
  this.currentQuery = query
  this.currentQueryInitialState = query.state
  this.previousQueryResult = this.currentResult
  ...
}
```

í˜„ì¬ `Query` ê°ì²´ê°€ ì—†ëŠ” ìƒíƒœë‹ˆê¹Œ ìš°ì„  ë§Œë“¤ì–´ì•¼ê² ì£ ? ê·¸ ë™ì‘ì„ 2ë²ˆ ë¼ì¸ì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤. `this.client.getQueryCache()`ë¥¼ í†µí•´ `QueryCache` ê°ì²´ë¥¼ ê°€ì§€ê³ ì™€ì„œ `build()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì¤ë‹ˆë‹¤.

```ts:QueryCache.build() showLineNumbers {9,12-21}
build<TQueryFnData, TError, TData, TQueryKey extends QueryKey>(
  client: QueryClient,
  options: QueryOptions<TQueryFnData, TError, TData, TQueryKey>,
  state?: QueryState<TData, TError>,
): Query<TQueryFnData, TError, TData, TQueryKey> {
  const queryKey = options.queryKey!
  const queryHash =
    options.queryHash ?? hashQueryKeyByOptions(queryKey, options)
  let query = this.get<TQueryFnData, TError, TData, TQueryKey>(queryHash)

  if (!query) {
    query = new Query({
      cache: this,
      logger: client.getLogger(),
      queryKey,
      queryHash,
      options: client.defaultQueryOptions(options),
      state,
      defaultOptions: client.getQueryDefaults(queryKey),
    })
    this.add(query)
  }

  return query
}
```

`useQuery`ì— ë„˜ê²¨ì¤€ key ê°’ì„ ì´ìš©í•´ 9ë²ˆ ë¼ì¸ì—ì„œ `QueryCache`ì— í•´ë‹¹ keyë¡œ ì €ì¥ëœ `Query`ê°€ ì¡´ì¬í•œë‹¤ë©´ ê°€ì ¸ì˜µë‹ˆë‹¤. í•˜ì§€ë§Œ í˜„ì¬ëŠ” ì—†ëŠ” ìƒíƒœë¯€ë¡œ 12 ~ 20ë²ˆ ë¼ì¸ì—ì„œ ìƒˆë¡œìš´ `Query`ê°€ ìƒì„±ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  [ìœ„ì—ì„œ](#query) ì„¤ëª…í•œëŒ€ë¡œ `Query` ê°ì²´ê°€ ìƒì„±ë˜ë©´ì„œ `QueryCache`ë¥¼ ê°€ì§€ê²Œë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  21ë²ˆ ë¼ì¸ì—ì„œ `QueryCache`ì—ë„ `Query`ë¥¼ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.

ì´ë ‡ê²Œ ìƒì„±ëœ `Query` ê°ì²´ë¥¼ ë°›ì•„ì™€ `QueryObserver.updateQuery()` í•¨ìˆ˜ì˜ 11ë²ˆ ë¼ì¸ì—ì„œ `QueryObserver`ì—ë„ ì €ì¥í•´ì¤ë‹ˆë‹¤.

![QueryObserver.updateQuery( ) í›„ ìƒíƒœ](https://i.imgur.com/lgOTZad.png)

ê·¸ë¦¬ê³  `updateQuery()`ë¥¼ ë§ˆì¹œ í›„ `setOptions()`ë¡œ ëŒì•„ì™€ `updateResult()`ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### updateResult()

```ts:QueryObserver.updateResult() showLineNumbers {6,15,17}
updateResult(notifyOptions?: NotifyOptions): void {
  const prevResult = this.currentResult as
    | QueryObserverResult<TData, TError>
    | undefined;

  const nextResult = this.createResult(this.currentQuery, this.options);
  this.currentResultState = this.currentQuery.state;
  this.currentResultOptions = this.options;

  // nextResultì™€ prevResultê°€ ë‹¤ë¥¼ ë•Œì—ë§Œ updateì™€ notifyë¥¼ ì‹¤í–‰
  if (shallowEqualObjects(nextResult, prevResult)) {
    return;
  }

  this.currentResult = nextResult;
  ...
  this.notify({ ...defaultNotifyOptions, ...notifyOptions });
}
```

6ë²ˆ ë¼ì¸ì˜ `createResult()` í•¨ìˆ˜ì—ì„œ í˜„ì¬ì˜ ìƒíƒœì™€ ì˜µì…˜ë“¤ì„ ì´ìš©í•´ `useQuery()`ë¥¼ ì‚¬ìš©í•œ ê³³ì— ë„˜ê²¨ì¤„ ê°’ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. ì´ë ‡ê²Œ ë§Œë“¤ì–´ì§„ resultë¥¼ `QueryObserver`ì— ì €ì¥í•˜ê³  notifyí•´ì¤„ì§€ ì—¬ë¶€ëŠ” 11ë²ˆ ë¼ì¸ì—ì„œ ì–•ì€ ë¹„êµë¥¼ í†µí•´ ê²°ì •í•©ë‹ˆë‹¤. ì§€ê¸ˆì€ `prevResult`ê°€ undefinedì´ë¯€ë¡œ 15ë²ˆ, 17ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.

15ë²ˆ ë¼ì¸ì—ì„œ `useQuery()`ì˜ returnì„ ìœ„í•´ `this.currentResult`ì— ì €ì¥í•˜ë©°, 17ë²ˆ ë¼ì¸ì—ì„œ notify í•´ì¤ë‹ˆë‹¤.

### notify()

```ts:QueryObserver.notify() showLineNumbers {2,5-7,11-14}
private notify(notifyOptions: NotifyOptions): void {
  notifyManager.batch(() => {
    ...
    if (notifyOptions.listeners) {
      this.listeners.forEach((listener) => {
        listener(this.currentResult);
      });
    }

    if (notifyOptions.cache) {
      this.client.getQueryCache().notify({
        query: this.currentQuery,
        type: 'observerResultsUpdated',
      });
    }
  });
}
```

2ë²ˆ ë¼ì¸ì—ì„œ `notifyManager.batch()`ë¥¼ í•´ì£¼ê³  ìˆìŠµë‹ˆë‹¤. `batch()` í•¨ìˆ˜ë¥¼ ë³´ê¸° ì „ì— ë„˜ê²¨ì£¼ëŠ” callback í•¨ìˆ˜ë¶€í„° ë³´ê² ìŠµë‹ˆë‹¤. 5 ~ 7ë²ˆ ë¼ì¸ì˜ ì½”ë“œëŠ” í˜„ì¬ë¡œì¨ëŠ” ì•„ë¬´ê²ƒë„ í•´ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ `QueryObserver`ì— ë“±ë¡ëœ `listeners`ê°€ ì—†ê¸° ë•Œë¬¸ì´ì£ . í•˜ì§€ë§Œ ë‚˜ì¤‘ì— `useQuery()`ì˜ ë¹„ë™ê¸° í•¨ìˆ˜ê°€ ì™„ë£ŒëŠ” ì‹œì ì— í° ì˜ë¯¸ê°€ ìˆìŠµë‹ˆë‹¤. ì§€ê¸ˆì€ ê·¸ëƒ¥ ë„˜ì–´ê°€ê³  ê·¸ ë•Œ ë‹¤ì‹œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

11 ~ 14ë²ˆ ë¼ì¸ì—ì„œ `QueryCache`ë¥¼ ê°€ì ¸ì™€ ë‹¤ì‹œ `QueryCache.notify()`ë¥¼ í•´ì¤ë‹ˆë‹¤. `QueryObserver`ì—ë„ notifyê°€ ìˆê³  `QueryCache`ì—ë„ notifyê°€ ìˆê³ , notifyê°€ ë§ì•„ì„œ í—·ê°ˆë¦¬ì£ ? ê° ê°ì²´ê°€ ê°–ê³  ìˆëŠ” `notify()` í•¨ìˆ˜ì˜ ì£¼ëœ ì—­í• ì€ ê°ì²´ì— ë“±ë¡ëœ listener, observer ë“¤ì„ í˜¸ì¶œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. `QueryObserver`ëŠ” ê·¸ ì™¸ì— ì¶”ê°€ì ìœ¼ë¡œ `QueryCache`ì— resultê°€ ë³€ê²½ë˜ì—ˆë‹¤ê³  ì•Œë ¤ì£¼ëŠ” ì—­í• ê¹Œì§€ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ `QueryCache`ì˜ notify í•¨ìˆ˜ë„ ë³´ê² ìŠµë‹ˆë‹¤.

```ts:QueryCache.notify() {2}
notify(event: QueryCacheNotifyEvent) {
  notifyManager.batch(() => {
    this.listeners.forEach((listener) => {
      listener(event);
    });
  });
}
```

ë³„ê±° ì—†ì£ ? ìœ„ì—ì„œ ì–˜ê¸°í•œëŒ€ë¡œ listenerë“¤ì„ í˜¸ì¶œí•˜ëŠ” ê²ƒ ë§ê³ ëŠ” ë”±íˆ ì—†ìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì—¬ê¸°ì—ì„œë„ `notifyManager.batch()` í•¨ìˆ˜ê°€ ë³´ì´ë„¤ìš”. ì´ë²ˆì—ëŠ” ì´ í•¨ìˆ˜ë¥¼ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

## batch()

```ts:notifyManager.batch() showLineNumbers {7,9,11,13}
export function createNotifyManager() {
  let queue: NotifyCallback[] = []
  let transactions = 0
  ...
  const batch = <T>(callback: () => T): T => {
    let result
    transactions++
    try {
      result = callback()
    } finally {
      transactions--
      if (!transactions) {
        flush()
      }
    }
    return result
  }
  ...
}
```

ì´ í•¨ìˆ˜ë¥¼ ë³´ê¸° ì „ì— í€´ì¦ˆì…ë‹ˆë‹¤. í˜„ì¬ `batch()` í•¨ìˆ˜ê°€ ëª‡ ë²ˆ í˜¸ì¶œ ë˜ì—ˆëŠ”ì§€ ê¸°ì–µí•˜ì‹œë‚˜ìš”? ë„¤, 2ë²ˆ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. QueryObserverì—ì„œ 1ë²ˆ, QueryCacheì—ì„œ 1ë²ˆ. ì´ 2ë²ˆ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ì–µí•˜ê³  ê³„ì‹ ë‹¤ë©´ QueryObserverì—ì„œì˜ batch()ê°€ ëë‚˜ê¸° ì „ì— QueryCacheì˜ batch()ê°€ í˜¸ì¶œë˜ì—ˆë‹¤ëŠ” ê²ƒë„ ê¸°ì–µí•˜ì‹œë‚˜ìš”?

8ë²ˆ ë¼ì¸ì—ì„œ callback í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ë™ì‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ í•¨ìˆ˜ì—ì„œ ë” ì¤‘ìš”í•œ ê²ƒì€, 2ë²ˆì˜ `batch()`ì˜ í˜¸ì¶œë¡œ í˜„ì¬ 7ë²ˆ ë¼ì¸ì„ ë§‰ ì§€ë‚˜ê³  ìˆë‹¤ë©´ `transaction`ì€ 2ë¼ëŠ” ì‚¬ì‹¤ì…ë‹ˆë‹¤. QueryCache â†’ QueryObserver ìˆœìœ¼ë¡œ batch()ê°€ í˜¸ì¶œë˜ì—ˆìœ¼ë‹ˆ **QueryObserver â†’ QueryCache ìˆœìœ¼ë¡œ 11ë²ˆ ë¼ì¸ì„ ì§€ë‚˜ì•¼ ë¹„ë¡œì†Œ `transaction`ì´ 0ì´ ë©ë‹ˆë‹¤**. `transaction`ì´ 0ì´ ëœë‹¤ë©´ `flush()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤.

`flush()` í•¨ìˆ˜ëŠ” 2ë²ˆ ë¼ì¸ì˜ `queue`ì— ìŒ“ì¸ í•¨ìˆ˜ë“¤ì„ í•œ ë²ˆì— ì‹¤í–‰í•´ì£¼ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì´ ì„¤ê³„ë¡œ React QueryëŠ” batch^[ì—¬ê¸°ì„œì˜ batchëŠ” `notifyManager.batch()`ê°€ ì•„ë‹Œ ë” ë‚˜ì€ ì„±ëŠ¥ì„ ìœ„í•´ ì—¬ëŸ¬ ê°œì˜ state ì—…ë°ì´íŠ¸ë¥¼ í•˜ë‚˜ì˜ ë¦¬ë Œë”ë§ìœ¼ë¡œ ë¬¶ëŠ” batchë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.]ë¥¼ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤. ë’¤ì—ì„œ ë³´ê² ì§€ë§Œ `queue`ì—ëŠ” Component1ê³¼ Component2ì˜ ë¦¬ë Œë”ë§ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ê°€ ë“¤ì–´ê°€ê²Œ ë©ë‹ˆë‹¤. **ë§Œì•½ `queue`ì— ë¦¬ë Œë”ë§ì„ ëª¨ì•„ `flush()`ë¥¼ í†µí•´ í•œ ë²ˆì— ìˆ˜í–‰í•˜ëŠ” êµ¬ì¡°ê°€ ì•„ë‹ˆì—ˆë‹¤ë©´, Component1ì˜ ë¦¬ë Œë”ë§ê³¼ Component2ì˜ ë¦¬ë Œë”ë§ ì‚¬ì´ì— ë‹¤ë¥¸ ì½”ë“œë“¤ì„ ìˆ˜í–‰í•˜ëŠë¼ ì‹œê°„ì´ ê¸¸ì–´ì¡Œì„ ë•Œ Component1ê³¼ Component2ê°€ ë™ì‹œì— ë°”ë€Œì§€ ì•Šê³  2ë²ˆì— ê±¸ì³ ë°”ë€ŒëŠ” ê²ƒì²˜ëŸ¼ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤**. ì´ëŸ° ë¬¸ì œì ì„ í´ë¡œì €ë¡œ `transaction`, `queue`ë¥¼ ê´€ë¦¬í•˜ë©° í•´ê²°í•œ ê²ƒì…ë‹ˆë‹¤.

QueryObserverì™€ QueryCacheì˜ `batch()` í•¨ìˆ˜ê°€ ì¢…ë£Œë˜ë©´ `QueryObserver` ì˜ `updateResult()`, `setOptions()`ê°€ ì¢…ë£Œë˜ê³ , `QueryObserver`ì˜ ìƒì„±ì í•¨ìˆ˜ë„ ì¢…ë£Œë˜ì–´ ë“œë””ì–´ `useBaseQuery()`ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.

## ë§ˆì¹˜ë©°

ì—­ì‹œ í•œ í¸ ì•ˆì— ì•ˆëë‚˜ë„¤ìš”. ê¸¸ì–´ì§ˆ ì¤„ì€ ì•Œê³  ìˆì—ˆì§€ë§Œ ì´ ì •ë„ì¼ ì¤„ì´ì•¼... ì•„ì§ ì´ì•¼ê¸°í•  ë‚´ìš©ì´ ë§ìŠµë‹ˆë‹¤. `useSyncExternalStore`, ë¦¬ì•¡íŠ¸ ë‚´ë¶€ ì½”ë“œì¸ `subscribeToStore`, ì–¸ì œ, ì–´ë””ì„œ, ì–´ë–»ê²Œ ë¹„ë™ê¸° í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ëŠ”ì§€, Component2ëŠ” Component1ì´ ì´ë¯¸ ë¹„ë™ê¸° ìš”ì²­ì„ í–ˆëŠ”ì§€ ì–´ë–»ê²Œ ì•Œê³  ìš”ì²­ì„ ë³´ë‚´ì§€ ì•ŠëŠ”ì§€ ë“± ë§ í•  ë‚´ìš©ì´ ìˆ˜ë‘ë£©í•©ë‹ˆë‹¤. ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì‘ì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ğŸ™ƒ

**ì˜¤íƒ€ ë° ì˜¤ë¥˜ ì§€ì ì€ ì–¸ì œë‚˜ í™˜ì˜ì…ë‹ˆë‹¤!**
