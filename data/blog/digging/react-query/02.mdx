---
title: '[React Query] useQuery ë™ì‘ì›ë¦¬(2)'
date: '2023-02-13'
lastmod: '2023-02-13'
tags: ['React Query','ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶„ì„']
draft: false
series: ë™ì‘ì›ë¦¬
summary: Tanstack Query(React Query)ì˜ useQueryì˜ ë™ì‘ì›ë¦¬ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤. ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” QueryObserver ìƒì„± í›„ ë™ì‘ì— ëŒ€í•´ì„œ ë‹¤ë£¹ë‹ˆë‹¤.
images: [https://i.imgur.com/31mL9jU.png]
layout: PostLayout
---

## ë¶„ì„í•˜ê¸° ì•ì„œ

[ì €ë²ˆ í¬ìŠ¤íŠ¸](https://www.timegambit.com/blog/digging/react-query/01)ì—ì„œ ë‹¤ë£¨ì—ˆë˜ ë‚´ìš©ì´ ê¸°ì–µë‚˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë‹¤ì‹œ í•œ ë²ˆ ì½ì–´ì£¼ì„¸ìš”. ê·¸ë˜ë„ ê°„ë‹¨íˆ ì •ë¦¬ëŠ” í•œ ë²ˆ í•˜ê³  ê°€ê² ìŠµë‹ˆë‹¤.

### ê°ì²´ë“¤ê°„ì˜ ê´€ê³„

![ê°ì²´ê°„ì˜ ê´€ê³„](https://i.imgur.com/O6pncr8.png,https://i.imgur.com/bUkSevN.png)

ì¤‘ìš”í•œ ê°ì²´ê°€ 4ê°œ ìˆë‹¤ê³  í–ˆìŠµë‹ˆë‹¤. `QueryClient`, `QueryCache`, `Query`, `QueryObserver`. ì´ 4ê°œì˜ ê°ì²´ ì‚¬ì´ì˜ ê´€ê³„ëŠ” ìœ„ ì´ë¯¸ì§€ì™€ ê°™ìŠµë‹ˆë‹¤. ì´ ê°ì²´ ì™¸ì— í´ë¡œì €ë¥¼ ì‚¬ìš©í•˜ë©° singletonìœ¼ë¡œ ê´€ë¦¬ë˜ëŠ” `notifyManager` ê°ì²´ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. `notifyManager`ëŠ” 4ê°œì˜ ê°ì²´ ì‚¬ì´ì— ì´ë²¤íŠ¸ë¥¼ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.


![QueryObserver ìƒì„± ì´í›„ ìƒíƒœ](https://i.imgur.com/Ema2Q2p.png,https://i.imgur.com/g9rYuvm.png)

ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ Component1ì´ `useQuery()`ë¥¼ í˜¸ì¶œí•˜ì—¬ `QueryObserver`ê°€ useStateë¥¼ ì´ìš©í•´ ìƒì„±ëœ ë¶€ë¶„ê¹Œì§€ ì„¤ëª…í•˜ì˜€ìŠµë‹ˆë‹¤.

```ts:useBaseQuery.ts showLineNumbers {11-14,17,19,24,34}
export function useBaseQuery<...>(
  options: UseBaseQueryOptions<...>,
  Observer: typeof QueryObserver,
) {
  const queryClient = useQueryClient({ context: options.context })
  const defaultedOptions = queryClient.defaultQueryOptions(options)
  ...

  const [observer] = React.useState(
    () =>
      new Observer<TQueryFnData, TError, TData, TQueryData, TQueryKey>(
        queryClient,
        defaultedOptions,
      ),
  )

  const result = observer.getOptimisticResult(defaultedOptions)

  useSyncExternalStore(
    React.useCallback(
      (onStoreChange) =>
        isRestoring
          ? () => undefined
          : observer.subscribe(notifyManager.batchCalls(onStoreChange)),
      [observer, isRestoring],
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult(),
  )

  ...

  return !defaultedOptions.notifyOnChangeProps
    ? observer.trackResult(result)
    : result
}
```

11 ~ 14ë²ˆ ë¼ì¸ì—ì„œ `QueryObserver`ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” 17ë²ˆ, 19ë²ˆ, 24ë²ˆ, 34ë²ˆ ë¼ì¸ì—ì„œ ë¹„ë¡¯ë˜ëŠ” ë™ì‘ë“¤ì„ ë‹¤ë£° ê²ƒì…ë‹ˆë‹¤.

## getOptimisticResult()

```ts:Observer.getOptimisticResult() {6}
getOptimisticResult(
  options: DefaultedQueryObserverOptions<...>
): QueryObserverResult<TData, TError> {
  const query = this.client.getQueryCache().build(this.client, options);

  return this.createResult(query, options);
}
```

ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ `QueryCache.build()` í•¨ìˆ˜ë¥¼ ë¶„ì„í–ˆìœ¼ë‹ˆ ì´ë²ˆì—ëŠ” `createResult()` í•¨ìˆ˜ë¥¼ ë¶„ì„í•´ë³´ê² ìŠµë‹ˆë‹¤.

```ts:Observer.createResult() showLineNumbers {6-7,11,17}
protected createResult(
  query: Query<TQueryFnData, TError, TQueryData, TQueryKey>,
  options: QueryObserverOptions<...>
): QueryObserverResult<TData, TError> {
  ...
  const { state } = query;
  let { dataUpdatedAt, error, errorUpdatedAt, fetchStatus, status } = state;
  ...
  let data: TData | undefined;
  ...
  data = state.data as unknown as TData;
  ...
  const isFetching = fetchStatus === 'fetching';
  const isLoading = status === 'loading';
  const isError = status === 'error';

  const result: QueryObserverBaseResult<TData, TError> = {
    status,
    fetchStatus,
    isLoading,
    isSuccess: status === 'success',
    isError,
    isInitialLoading: isLoading && isFetching,
    data,
    dataUpdatedAt,
    error,
    errorUpdatedAt,
    failureCount: state.fetchFailureCount,
    failureReason: state.fetchFailureReason,
    errorUpdateCount: state.errorUpdateCount,
    isFetched: state.dataUpdateCount > 0 || state.errorUpdateCount > 0,
    isFetchedAfterMount:
      state.dataUpdateCount > queryInitialState.dataUpdateCount ||
      state.errorUpdateCount > queryInitialState.errorUpdateCount,
    isFetching,
    isRefetching: isFetching && !isLoading,
    isLoadingError: isError && state.dataUpdatedAt === 0,
    isPaused: fetchStatus === 'paused',
    isPlaceholderData,
    isPreviousData,
    isRefetchError: isError && state.dataUpdatedAt !== 0,
    isStale: isStale(query, options),
    refetch: this.refetch,
    remove: this.remove,
  };

  return result as QueryObserverResult<TData, TError>;
}
```

`createResult()` í•¨ìˆ˜ëŠ” `useQuery()`ì˜ returnì— ì‚¬ìš©ë˜ëŠ” ê°ì²´ë¥¼ ë§Œë“œëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. (ë’¤ì—ì„œ ë³´ê² ì§€ë§Œ ì´ ê°ì²´ê°€ ì§ì ‘ì ìœ¼ë¡œ return ë˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.) 18 ~ 44ë²ˆ ë¼ì¸ì— ì •ì˜ëœ `result` ê°ì²´ì˜ ì†ì„±ë“¤ê³¼ [useQuery ê³µì‹ë¬¸ì„œ](https://tanstack.com/query/v4/docs/react/reference/useQuery)ì—ì„œ ì„¤ëª…í•˜ëŠ” ì†ì„±ë“¤ì´ ì¼ì¹˜í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## trackResult()

`useBaseQuery.ts`ì˜ ì½”ë“œì—ì„œ `getOptimisticResult()` í•¨ìˆ˜ ì´í›„ì— `useSyncExternalStore()`ê°€ í˜¸ì¶œë˜ì§€ë§Œ, ì´ í•¨ìˆ˜ë¥¼ ì†Œê°œí•˜ê¸° ì „ì— ë¨¼ì € `trackResult()` í•¨ìˆ˜ë¶€í„° ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤. ì´ìœ ëŠ” 2ê°€ì§€ì…ë‹ˆë‹¤. ì²« ë²ˆì§¸, í˜¸ì¶œ ìì²´ëŠ” `useSyncExternalStore()`ì´ `trackResult()`ë³´ë‹¤ ë¨¼ì €ì§€ë§Œ, ì‹¤ì§ˆì ì¸ ë™ì‘ì€ `useSyncExternalStore()`ì´ `trackResult()` ì´í›„ì— ì´ë¤„ì§€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë‘ ë²ˆì§¸, `useSyncExternalStore()`ì´ ì´ë²ˆ ì„¤ëª…ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë§›ìˆëŠ”ê±´ ë‚˜ì¤‘ì— ë¨¹ì–´ì•¼ ë” ê¿€ë§›ì´ì£ . ğŸ˜‹

```ts:Observer.trackResult() showLineNumbers {7,11}
trackResult(
  result: QueryObserverResult<TData, TError>
): QueryObserverResult<TData, TError> {
  const trackedResult = {} as QueryObserverResult<TData, TError>;

  Object.keys(result).forEach((key) => {
    Object.defineProperty(trackedResult, key, {
      configurable: false,
      enumerable: true,
      get: () => {
        this.trackedProps.add(key as keyof QueryObserverResult);
        return result[key as keyof QueryObserverResult];
      },
    });
  });

  return trackedResult;
}
```

`trackResult()`ì˜ return ê°’ì¸ `trackedResult`ê°€ `useBaseQuery()`ì˜ return ê°’ì´ ë˜ë¯€ë¡œ, ê²°ê³¼ì ìœ¼ë¡œ `useQuery()`ì˜ return ê°’ì´ ë©ë‹ˆë‹¤.

ì½”ë“œë¥¼ ë³´ë‹ˆ `Object.defineProperty()`, ê·¸ë¦¬ê³  ê·¸ ë‚´ë¶€ì— `get()`ì´ ë³´ì´ë„¤ìš”. *ì´ê²Œ ë­ì§€?* í•˜ì‹ ë‹¤ë©´ [ì´ í¬ìŠ¤íŠ¸](https://www.timegambit.com/blog/js/object-define-property)ë¥¼ ë´ì£¼ì„¸ìš”. ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ `this.trackedProps`ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ì—ì„œ `useQuery()`ë¥¼ í†µí•´ ì–´ë–¤ ë°ì´í„°ë¥¼ ìš”ì²­í–ˆëŠ”ì§€ ì €ì¥í•œë‹¤ê³  í–ˆìŠµë‹ˆë‹¤. 11ë²ˆ ë¼ì¸ì—ì„œ ì´ ë™ì‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. `result`ëŠ” ìœ„ì—ì„œ ì„¤ëª…í•œ `createResult()`ë¥¼ í†µí•´ ë§Œë“¤ì–´ì§„ ê°’ì…ë‹ˆë‹¤. `result`ì™€ `Object.defineProperty()`ë¥¼ ì´ìš©í•´ `trackedResult`ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤. ë‹¤ë§Œ `value` í‚¤ì›Œë“œë¡œ ê°’ì„ ì €ì¥í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, `get()` í•¨ìˆ˜ë¥¼ ì •ì˜í•¨ìœ¼ë¡œì¨ ê°’ì„ ì–»ê¸° ì „ì— 11ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•˜ë„ë¡ êµ¬í˜„ë˜ì–´ìˆìŠµë‹ˆë‹¤. 11ë²ˆ ë¼ì¸ì—ì„œ `this.trackedProps`ì— ì–´ë–¤ ê°’ë“¤ì„ ìš”ì²­í–ˆëŠ”ì§€ ì €ì¥í•˜ì—¬ `QueryObserver`ëŠ” `useQuery()`ë¥¼ í†µí•´ ì–´ë–¤ ê°’ì„ ìš”ì²­í–ˆëŠ”ì§€ ê¸°ì–µí•©ë‹ˆë‹¤. ì €ëŠ” ì´ê²ƒì„ ë³´ê³  ê½¤ ì¬ë°ŒëŠ” ë°©ë²•ì´ë¼ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì€ ì•Œì•„ë‘ë©´ ì–¸ì  ê°€ ì“¸ëª¨ê°€ ìˆì„ ê²ƒ ê°™ë„¤ìš”.

## useSyncExternalStore

`useSyncExternalStore`ì´ë¼ëŠ” hookì„ ë“¤ì–´ë³´ì‹  ë¶„ì´ ê³„ì‹ ê°€ìš”? ì•„ë§ˆ ë“¤ì–´ë³´ì‹  ë¶„ë³´ë‹¤ ì²˜ìŒ ë“¤ì–´ë³´ì‹œëŠ” ë¶„ì´ ë” ë§ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤. React 18ì— ìƒˆë¡­ê²Œ ì¶”ê°€ëœ hookìœ¼ë¡œ, props, useState, context apiì™€ ê°™ì´ ë¦¬ì•¡íŠ¸ê°€ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” ìƒíƒœ(Internal Store) ì™¸ì— ë¦¬ì•¡íŠ¸ ë°”ê¹¥ì—ì„œ ê´€ë¦¬í•˜ëŠ” ìƒíƒœ(External Store)ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œì—ë„ ë¦¬ë Œë”ë§ì´ ì´ë¤„ì§€ë„ë¡ í•´ì£¼ëŠ” hookì…ë‹ˆë‹¤. ë§Œì•½ ì´ëŸ° ê¸°ëŠ¥ì´ í•„ìš”í•˜ë”ë¼ë„ `useSyncExternalStore`ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ë³´í†µ ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì´ hookì˜ í•„ìš”ì„±ì„ ëŠê»´ë³´ì‹  ë¶„ì´ ê±°ì˜ ì—†ì„ ê²ƒì…ë‹ˆë‹¤. [hyeoki!ë‹˜](https://itchallenger.tistory.com/650)ê³¼ [danteë‹˜](https://velog.io/@jay/useSyncExternalStore)ê»˜ì„œ ì´ hookì— ëŒ€í•´ ìì„¸íˆ ì„¤ëª…í•´ë†“ìœ¼ì…¨ìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” `useSyncExternalStore` ìì²´ë³´ë‹¤ ì´ë¥¼ ì‚¬ìš©í•´ì„œ ì–´ë–¤ ì¼ì´ ì´ë¤„ì§€ëŠ”ì§€ë¥¼ ë¶„ì„í•˜ê² ìŠµë‹ˆë‹¤.

### subscribeToStore()

```ts:react-dom.subscribeToStore() showLineNumbers {2,7,12}
function subscribeToStore(fiber, inst, subscribe) {
  var handleStoreChange = function () {
    // The store changed. Check if the snapshot changed since the last time we
    // read from the store.
    if (checkIfSnapshotChanged(inst)) {
      // Force a re-render.
      forceStoreRerender(fiber);
    }
  }; // Subscribe to the store and return a clean-up function.


  return subscribe(handleStoreChange);
}
```

```ts:useBaseQuery.ts showLineNumbers {8-11}
export function useBaseQuery<...>(
  options: UseBaseQueryOptions<...>,
  Observer: typeof QueryObserver,
) {
  ...
  useSyncExternalStore(
    React.useCallback(
      (onStoreChange) =>
        isRestoring
          ? () => undefined
          : observer.subscribe(notifyManager.batchCalls(onStoreChange)),
      [observer, isRestoring],
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult(),
  )
  ...
}
```

`subscribeToStore()` í•¨ìˆ˜ëŠ” react-domì— ì •ì˜ëœ ì½”ë“œì…ë‹ˆë‹¤.`useBaseQuery()`ê°€ returnëœ ì´í›„ì— `useSyncExternalStore`ë¡œ ì¸í•´ `subscribeToStore()` í•¨ìˆ˜ê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤. ê° í•¨ìˆ˜ì˜ ë³€ìˆ˜ë“¤ì´ í—·ê°ˆë¦´ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ì„œ ê° í•¨ìˆ˜ì˜ ì…ì¥ì—ì„œ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

#### subscribeToStore()

* `inst`: ì´ì „ ìƒíƒœì™€ í˜„ì¬ ìƒíƒœë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë¥¼ ì§€ë‹Œ ê°ì²´ë¡œ, ë‹¤ìŒ ê°’ë“¤ì„ ê°–ê³  ìˆìŠµë‹ˆë‹¤.
  * value: `QueryObserver.createResult()`ë¥¼ í†µí•´ ë§Œë“¤ì–´ì§„ ê°’
  * getSnapshot: í˜„ì¬ ìƒíƒœë¥¼ ì–»ëŠ” í•¨ìˆ˜ë¡œ `useSyncExternalStore()`ì˜ ë‘ ë²ˆì§¸ ì¸ì. QueryObserverì— ì €ì¥ëœ `currentResult`ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
* `subscribe`: External Storeì— êµ¬ë…ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ë¡œ, ìœ„ `useBaseQuery.ts` ì½”ë“œì˜ 8 ~ 11ë²ˆ ë¼ì¸ì— ì •ì˜ëœ í•¨ìˆ˜ì…ë‹ˆë‹¤.

2ë²ˆ ë¼ì¸ì˜ `handleStoreChange()` í•¨ìˆ˜ëŠ” ì´ì „ ìƒíƒœ(`inst.value`)ì™€ í˜„ì¬ ìƒíƒœ(`inst.getSnapshot()`)ë¥¼ ë¹„êµí•˜ì—¬ ë‹¤ë¥´ë‹¤ë©´ ë¦¬ë Œë”ë§ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” `subscribe()` í•¨ìˆ˜ì˜ callback í•¨ìˆ˜ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

#### useBaseQueryì˜ useSyncExternalStore()

* `onStoreChange`: `subscribeToStore()`ë‚´ì— ì •ì˜ëœ `handleStoreChange()` í•¨ìˆ˜ì…ë‹ˆë‹¤.

`notifyManager.batchCalls()` í•¨ìˆ˜ì˜ callback í•¨ìˆ˜ë¡œ `onStoreChange`, ì¦‰ `handleStoreChange` í•¨ìˆ˜ê°€ ì „ë‹¬ë©ë‹ˆë‹¤.

## notifyManager

### batchCalls()

```ts:utils.ts
export function sleep(timeout: number): Promise<void> {
  return new Promise((resolve) => {
    setTimeout(resolve, timeout);
  });
}

export function scheduleMicrotask(callback: () => void) {
  sleep(0).then(callback);
}
```

```ts:notifyManager.ts showLineNumbers {7,9-11,16-20}
let notifyFn: NotifyFunction = (callback) => {
  callback();
};

const schedule = (callback: NotifyCallback): void => {
  if (transactions) {
    queue.push(callback);
  } else {
    scheduleMicrotask(() => {
      notifyFn(callback);
    });
  }
};

const batchCalls = <T extends Function>(callback: T): T => {
  return ((...args: any[]) => {
    schedule(() => {
      callback(...args);
    });
  }) as any;
};
```

`batchCalls()` í•¨ìˆ˜ì˜ ì¸ìì¸ `callback`ì€ `subscribeToStore()` í•¨ìˆ˜ì— ì •ì˜ëœ `handleStoreChange` í•¨ìˆ˜ì…ë‹ˆë‹¤. ì¦‰, `callback`ì€ External Storeì˜ ìƒíƒœê°€ ë³€ê²½ë  ë•Œ, ë” ìì„¸íˆ ë§í•˜ìë©´ `QueryObserver.currentResult`ê°€ ë³€ê²½ë  ë•Œ ë¦¬ë Œë”ë§ì„ ìœ ë°œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¦¬ë Œë”ë§ì´ í•œ ë²ˆì— ì¼ì–´ë‚  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ `schedule()`ì„ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ë¥¼ `batchCalls()`ê°€ return í•©ë‹ˆë‹¤.

`schedule()` í•¨ìˆ˜ëŠ” transactionì´ ì§„í–‰ë˜ëŠ” ì¤‘ì´ë¼ë©´ `queue`ì— ë¦¬ë Œë”ë§ì„ ìœ ë°œí•˜ëŠ” `callback` í•¨ìˆ˜ë¥¼ ë„£ì–´ì£¼ê³ , transactionì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆë¼ë©´ `scheduleMicrotask()`ë¥¼ í†µí•´ íƒœìŠ¤í¬ í[^ì´ë²¤íŠ¸ ë£¨í”„]ì— `callback` í•¨ìˆ˜ê°€ ë“¤ì–´ê°€ë„ë¡ í•©ë‹ˆë‹¤.

## êµ¬ë…ìš”ì²­

### subscribe()

```ts:useBaseQuery.ts showLineNumbers {8-11}
export function useBaseQuery<...>(
  options: UseBaseQueryOptions<...>,
  Observer: typeof QueryObserver,
) {
  ...
  useSyncExternalStore(
    React.useCallback(
      (onStoreChange) =>
        isRestoring
          ? () => undefined
          : observer.subscribe(notifyManager.batchCalls(onStoreChange)),
      [observer, isRestoring],
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult(),
  )
  ...
}
```

`notifyManager.batchCalls()` í•¨ìˆ˜ê°€ return í•´ì£¼ëŠ” í•¨ìˆ˜ë¥¼ callbackìœ¼ë¡œ ë°›ì•„ `QueryObserver.subscribe()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ì´ í•¨ìˆ˜ë¥¼ ë³´ê² ìŠµë‹ˆë‹¤.

```ts:subscribable.ts showLineNumbers {4,6}
export class Subscribable<TListener extends Function = Listener> {
  ...
  subscribe(listener: TListener): () => void {
    this.listeners.push(listener as TListener)

    this.onSubscribe()

    return () => {
      this.listeners = this.listeners.filter((x) => x !== listener)
      this.onUnsubscribe()
    }
  }
  ...
}
```

3ë²ˆ ë¼ì¸ì—ì„œ ì¸ìë¡œ ë°›ëŠ” `listener`ê°€ ì •í™•íˆ ë¬´ì—‡ì¼ê¹Œìš”? [notifyManager.ts ì½”ë“œ](#batchcalls)ì˜ 16 ~ 20ë²ˆ ë¼ì¸ì˜ í•¨ìˆ˜ì…ë‹ˆë‹¤. ì¦‰, ë¦¬ë Œë”ë§ì„ ì•¼ê¸°í•˜ëŠ” í•¨ìˆ˜ê°€ `listener`ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¦¬ë Œë”ë§ ìœ ë°œ í•¨ìˆ˜ê°€ 4ë²ˆ ë¼ì¸ì„ í†µí•´ `QueryObserver`ì˜ `listeners`ì— ì¶”ê°€ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  `onSubscribe()` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì£ .

<Alert type="info">
  ê°‘ìê¸° ëª» ë³´ë˜ í´ë˜ìŠ¤ì¸ `Subscribable`ì´ íŠ€ì–´ ë‚˜ì™”ë„¤ìš”. í•˜ì§€ë§Œ ì‚¬ì‹¤ ì´ í´ë˜ìŠ¤ë¥¼ ìì„¸íˆ ë‹¤ë£¨ì§€ ì•Šì•˜ì„ ë¿, ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ ìŠ¤ì³ì§€ë‚˜ê°€ë“¯ ë³´ì•˜ìŠµë‹ˆë‹¤.

  ```ts
  // queryCache.ts
  export class QueryCache extends Subscribable<QueryCacheListener> {
  ...
}

  // queryObserver.ts
  export class QueryObserver<...> extends Subscribable<QueryObserverListener<TData, TError>> {
    ...
  }
  ```

  `QueryCache`ì™€ `QueryObserver` í´ë˜ìŠ¤ëŠ” `Subscribable` í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ê³  ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ `QueryCache`ì™€ `QueryObserver` ê°ì²´ëŠ” `Subscribable` í´ë˜ìŠ¤ê°€ ê°€ì§€ëŠ” `listeners`ì™€ `subscribe()`ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
</Alert>

### onSubscribe()

```ts:QueryObserver.onSubscribe() showLineNumbers {3,6}
protected onSubscribe(): void {
  if (this.listeners.length === 1) {
    this.currentQuery.addObserver(this);

    if (shouldFetchOnMount(this.currentQuery, this.options)) {
      this.executeFetch();
    }

    this.updateTimers();
  }
}
```

ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œ ì„¤ëª…í–ˆë“¯ì´, 3ë²ˆ ë¼ì¸ì„ í†µí•´ `Query.observers`ì— í˜„ì¬ì˜ `QueryObserver`ê°€ ì¶”ê°€ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  6ë²ˆ ë¼ì¸ì˜ `executeFetch()`ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ê°€ `useQuery()`ë¥¼ í˜¸ì¶œí•  ë•Œ ë„£ì–´ì£¼ì—ˆë˜ `queryFn`ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

![3ë²ˆ ë¼ì¸ í›„ ê°ì²´ê°„ ê´€ê³„](https://i.imgur.com/tt2iaDY.png,https://i.imgur.com/FliMAEG.png)

3ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•˜ê¸° ì „ì—ëŠ” `QueryObserver1`ë§Œ `Query` ê°ì²´ë¥¼ ì•Œê³  ìˆì—ˆì§€ë§Œ, 3ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•˜ë©´ì„œ `Query`ë„ `QueryObserver1`ì„ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê´€ê³„ì˜ ë³€í™”ê°€ í° ì—­í• ì„ í•©ë‹ˆë‹¤. ê¸°ì–µí•´ì£¼ì„¸ìš”! ì´ì œ 6ë²ˆ ë¼ì¸ì˜ `executeFetch()`ë¥¼ ë´…ì‹œë‹¤.

## queryFn ì‹¤í–‰

ì§€ê¸ˆê¹Œì§€ ê¸¸ê³  ê¸´ ì¤€ë¹„ë¥¼ ë§ˆì¹˜ê³ , ë“œë””ì–´ ë¹„ë™ê¸° ìš”ì²­ì„ ë³´ë‚¼ ì‹œê°„ì…ë‹ˆë‹¤!

### executeFetch()

```ts:QueryObserver.executeFetch() showLineNumbers {7-10}
private executeFetch(
  fetchOptions?: ObserverFetchOptions
): Promise<TQueryData | undefined> {
  this.updateQuery();

  // Fetch
  let promise: Promise<TQueryData | undefined> = this.currentQuery.fetch(
    this.options as QueryOptions<TQueryFnData, TError, TQueryData, TQueryKey>,
    fetchOptions
  );

  if (!fetchOptions?.throwOnError) {
    promise = promise.catch(noop);
  }

  return promise;
}
```

í° ì—­í• ì„ í•˜ëŠ” í•¨ìˆ˜ëŠ” ì•„ë‹™ë‹ˆë‹¤. ë‹¨ì§€ `Query.fetch()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ì—­í• ì„ í•´ì¤ë‹ˆë‹¤. ë¹ ë¥´ê²Œ `Query.fetch()`ë¡œ ë„˜ì–´ê°€ì‹œì£ .

### fetch()

```ts:Query.fetch() showLineNumbers {8-12,16}
fetch(
  options?: QueryOptions<TQueryFnData, TError, TData, TQueryKey>,
  fetchOptions?: FetchOptions,
): Promise<TData> {
  ...
  this.retryer = createRetryer({
    fn: context.fetchFn as () => TData,
    onSuccess: (data) => {
      ...
      this.setData(data as TData)
      ...
    },
    ...
  })

  this.promise = this.retryer.promise

  return this.promise
}
```

`Query.fetch()` í•¨ìˆ˜ëŠ” `createRetryer()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ë’¤ì—ì„œ ë³´ê² ì§€ë§Œ `createRetryer()` ë‚´ë¶€ì—ì„œ `useQuery()`ì˜ ì¸ìë¡œ ë„˜ê²¨ì¤€, ë¹„ë™ê¸° ìš”ì²­ í•¨ìˆ˜ì¸ `queryFn`ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

`createRetryer()`ë¥¼ ë³´ê¸° ì „ì— 2ê°€ì§€ë¥¼ ê¸°ì–µí•˜ê³  ê°‘ì‹œë‹¤. 10ë²ˆ ë¼ì¸ì—ì„œ `setData()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒ, ê·¸ë¦¬ê³  16ë²ˆ ë¼ì¸ì—ì„œ `Query.promise`ì— Promise ê°ì²´ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë¯¸ë¦¬ ë§ì”€ë“œë¦¬ìë©´ 10ë²ˆ ë¼ì¸ì˜ `setData()`ë¡œ ë¦¬ë Œë”ë§ì„ ì•¼ê¸°í•˜ê³ , 16ë²ˆ ë¼ì¸ìœ¼ë¡œ Component2ì˜ queryFnì´ ìˆ˜í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë’¤ì—ì„œ ì´ 2ê°€ì§€ì— ëŒ€í•´ ë”ìš± ìì„¸íˆ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤. ë¨¼ì € `createRetryer()`ë¶€í„° ë³´ê² ìŠµë‹ˆë‹¤.

### createRetryer()

```ts:createRetryer() showLineNumbers {15,26,31-32,36,40}
export function createRetryer<TData = unknown, TError = unknown>(
  config: RetryerConfig<TData, TError>,
): Retryer<TData> {
  let promiseResolve: (data: TData) => void
  let promiseReject: (error: TError) => void

  const promise = new Promise<TData>((outerResolve, outerReject) => {
    promiseResolve = outerResolve
    promiseReject = outerReject
  })

  const resolve = (value: any) => {
    if (!isResolved) {
      isResolved = true
      config.onSuccess?.(value)
      continueFn?.()
      promiseResolve(value)
    }
  }

  const run = () => {

    let promiseOrValue: any

    try {
      promiseOrValue = config.fn()
    } catch (error) {
      promiseOrValue = Promise.reject(error)
    }

    Promise.resolve(promiseOrValue)
    .then(resolve)
  }

  if (canFetch(config.networkMode)) {
    run()
  }

  return {
    promise,
    ...
  }
}
```

ìˆœì„œëŒ€ë¡œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

1. 36ë²ˆ ë¼ì¸ì—ì„œ 21ë²ˆ ë¼ì¸ì— ì •ì˜ëœ `run()`ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
2. 26ë²ˆ ë¼ì¸ì„ í†µí•´ ë¹„ë™ê¸° í•¨ìˆ˜ì¸ `queryFn`ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
3. 2ë²ˆ ë™ì‘ì„ ìˆ˜í–‰í•˜ë©´ì„œ ì–»ì€ Promise ê°ì²´ê°€ resolve ë˜ì—ˆì„ ë•Œ 12ë²ˆ ë¼ì¸ì˜ `resolve()` í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.
4. `resolve()` í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë©´ `queryFn`ì„ í†µí•´ ì–»ì€ ë°ì´í„°ë¥¼ ì¸ìë¡œ í•˜ì—¬ [Query.fetch() ì½”ë“œ 8 ~ 12ë²ˆ ë¼ì¸ì— ì •ì˜ëœ](#fetch) `onSuccess()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
5. `onSuccess()` í•¨ìˆ˜ì—ì„œ `queryFn`ìœ¼ë¡œ ì–»ì€ ë°ì´í„°ë¥¼ ì´ìš©í•´ `Query.setData()`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

ë‹¤ìŒì€ ëŒ€ëµì ì¸ ì„¤ëª…ë§Œ ë“£ê³  ë¶„ì„í•˜ì§€ ì•Šì€ `Query.setData()`ë¥¼ ë³´ê² êµ¬ë‚˜ ìƒê°í•˜ì…¨ë‚˜ìš”? ì•„ì‰½ì§€ë§Œ ì•„ë‹™ë‹ˆë‹¤! ì§€ê¸ˆê¹Œì§€ Component1ì„ ì—´ì‹¬íˆ ë³´ì•˜ì§€ë§Œ Component2ì— ëŒ€í•´ì„œëŠ” ì•„ì§ í•˜ë‚˜ë„ ë³´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Component1ì´ ë¹„ë™ê¸° ìš”ì²­ì„ ë³´ëƒˆë‹¤ë©´ Component2ëŠ” ë³´ë‚´ì§€ ì•ŠëŠ” ê²ƒì´ íš¨ìœ¨ì ì´ë©° ì‹¤ì œë¡œë„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤. Component2ëŠ” ì–´ë–»ê²Œ ì´ë¯¸ ì´ì „ì— ìš”ì²­ì„ ë³´ëƒˆë‹¤ëŠ” ê²ƒì„ ì•Œê¹Œìš”?

## Component2

Component2ê°€ `useQuery()`ë¥¼ ì‚¬ìš©í•˜ë©´ `Query.fetch()`ë¥¼ ìˆ˜í–‰í•˜ê¸° ì „ê¹Œì§€, ë³´ì•„ì˜¨ ê²ƒê³¼ ë˜‘ê°™ì´ ë™ì‘í•©ë‹ˆë‹¤.

![ê°ì²´ê°„ ê´€ê³„](https://i.imgur.com/dGW2rwB.png,https://i.imgur.com/xteZhC2.png)

ê·¸ëŸ¬ë©´ ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ ê´€ê³„ê°€ ì„¤ì •ë©ë‹ˆë‹¤. ì¤‘ìš”í•œ ê²ƒì€ Component1ê³¼ Component2ê°€ ê°™ì€ `Query` ê°ì²´ë¥¼ ê°–ê²Œ ëœë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

```ts:Query.fetch() showLineNumbers {8-10,14,16}
fetch(
  options?: QueryOptions<TQueryFnData, TError, TData, TQueryKey>,
  fetchOptions?: FetchOptions,
): Promise<TData> {
  if (this.state.fetchStatus !== 'idle') {
    if (this.state.dataUpdatedAt && fetchOptions?.cancelRefetch) {
      this.cancel({ silent: true })
    } else if (this.promise) {
      this.retryer?.continueRetry()
      return this.promise
    }
  }
  ...
  this.retryer = createRetryer({ ... })

  this.promise = this.retryer.promise
  ...
}
```

Component1ì´ ë¨¼ì € `fetch()` í•¨ìˆ˜ë¥¼ ìˆ˜í–‰í•˜ë©´ì„œ 14, 16ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë”°ë¼ì„œ QueryObserver1ì´ ê°–ê³  ìˆëŠ” Queryì˜ `promise`ì— Promise ê°ì²´ê°€ ì €ì¥ëœ ìƒíƒœì…ë‹ˆë‹¤.

ì´ ìƒíƒœë¡œ Component2ì˜ `fetch()` í•¨ìˆ˜ë¥¼ ìˆ˜í–‰í•˜ê²Œ ë˜ë©´ 8ë²ˆ ë¼ì¸ì˜ else if ë¬¸ì— ê±¸ë¦¬ê²Œ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ `queryFn`ì„ ìˆ˜í–‰í•˜ëŠ” 14ë²ˆ ë¼ì¸ì— ë„ë‹¬í•˜ê¸° ì „ì— 10ë²ˆ ë¼ì¸ì—ì„œ return ë©ë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ Component1ì´ ë¨¼ì € ìš”ì²­ì„ ë³´ëƒˆê¸° ë•Œë¬¸ì— Component2ëŠ” ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šê²Œ ë˜ëŠ” ê²ƒì´ì£ .

## ë¦¬ë Œë”ë§

ì´ì œ ê±°ì˜ ë‹¤ ì™”ìŠµë‹ˆë‹¤! `setData()`ë¥¼ í†µí•´ ì–´ë–»ê²Œ ë¦¬ë Œë”ë§ë˜ëŠ”ì§€ ë³´ê² ìŠµë‹ˆë‹¤.

### setData()

```ts:Query.setData() showLineNumbers {5,7-12}
setData(
  newData: TData,
  options?: SetDataOptions & { manual: boolean },
): TData {
  const data = replaceData(this.state.data, newData, this.options)

  this.dispatch({
    data,
    type: 'success',
    dataUpdatedAt: options?.updatedAt,
    manual: options?.manual,
  })

  return data
}
```

`newData`ëŠ” `queryFn`ì´ resolve ë˜ë©´ì„œ ì–»ì€ ê°’ì…ë‹ˆë‹¤. ì´ ë°ì´í„°ë¥¼ 5ë²ˆ ë¼ì¸ì—ì„œ `Query.state.data`ì— ì €ì¥í•´ì¤ë‹ˆë‹¤. ê·¸ë¦¬ê³  ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŒì„ ì•Œë¦¬ê¸° ìœ„í•´, ì´ë²¤íŠ¸ typeì„ `success`ë¡œ í•˜ì—¬ `dispatch()` í•´ì¤ë‹ˆë‹¤.

### dispatch()

```ts:Query.dispatch() showLineNumbers {27-30}
private dispatch(action: Action<TData, TError>): void {
  const reducer = (
    state: QueryState<TData, TError>,
  ): QueryState<TData, TError> => {
  switch (action.type) {
    ...
    case 'success':
      return {
        ...state,
        data: action.data,
        dataUpdateCount: state.dataUpdateCount + 1,
        dataUpdatedAt: action.dataUpdatedAt ?? Date.now(),
        error: null,
        isInvalidated: false,
        status: 'success',
        ...(!action.manual && {
          fetchStatus: 'idle',
          fetchFailureCount: 0,
          fetchFailureReason: null,
        }),
      }
    ...
  }

  this.state = reducer(this.state)

  notifyManager.batch(() => {
    this.observers.forEach((observer) => {
      observer.onQueryUpdate(action)
    })

    this.cache.notify({ query: this, type: 'updated', action })
  })
}
```

QueryObserver2ì˜ `Query.fetch()`ê¹Œì§€ ëª¨ë‘ ìˆ˜í–‰í–ˆë‹¤ë©´ 28ë²ˆ ë¼ì¸ì˜ `this.observers`ì—ëŠ” ë­ê°€ ë“¤ì–´ìˆì„ê¹Œìš”? QueryObserver1ê³¼ QueryObserver2ê°€ ë“¤ì–´ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  28ë²ˆ ë¼ì¸ì˜ forEachë¬¸ì„ í†µí•´ ë‘ QueryObserverì˜ `onQueryUpdate()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. `onQueryUpdate()`ëŠ” `updateResult()`ë¥¼ í†µí•´ `QueryObserver`ì˜ `result`ë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ê³ , [ì €ë²ˆ í¬ìŠ¤íŠ¸](https://www.timegambit.com/blog/digging/react-query/01#notify)ì—ì„œ ì„¤ëª…í•œ `QueryObserver.notify()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

```ts:QueryObserver.notify() showLineNumbers {2,5-7}
private notify(notifyOptions: NotifyOptions): void {
  notifyManager.batch(() => {
    ...
    if (notifyOptions.listeners) {
      this.listeners.forEach((listener) => {
        listener(this.currentResult);
      });
    }
    ...
  });
}
```

ì €ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” `QueryObserver`ì˜ `listeners`ê°€ ë¹„ì–´ìˆì—ˆê¸° ë•Œë¬¸ì— 5 ~ 7ë²ˆ ë¼ì¸ì´ ì•„ë¬´ëŸ° ì—­í• ì„ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆì€ ë‹¤ë¦…ë‹ˆë‹¤. [notifyManager.batchCalls()](#batchcalls)ê°€ return í•´ì¤¬ë˜, ê·¸ë¦¬ê³  ë¦¬ë Œë”ë§ì„ ì•¼ê¸°í•˜ëŠ” í•¨ìˆ˜ê°€ `QueryObserver`ì˜ `listener`ë¡œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. 5 ~ 7ë²ˆ ë¼ì¸ì„ ìˆ˜í–‰í•˜ë©´ì„œ `notifyManager.queue`ì— ë¦¬ë Œë”ë§ í•¨ìˆ˜ê°€ ë“±ë¡ë©ë‹ˆë‹¤. ê·¸ê²ƒë„ QueryObserver1ê³¼ QueryObserver2, ê°ê°ì˜ ë¦¬ë Œë”ë§ í•¨ìˆ˜ê°€ ë“±ë¡ë˜ë¯€ë¡œ `notifyManager.queue`ì— 2ê°œì˜ ë¦¬ë Œë”ë§ í•¨ìˆ˜ê°€ ë“±ë¡ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  [ì €ë²ˆ í¬ìŠ¤íŠ¸ì˜ ì„¤ëª…ì²˜ëŸ¼](https://www.timegambit.com/blog/digging/react-query/01#batch) ëª¨ë“  `batch()` í•¨ìˆ˜ê°€ ëë‚˜ `transaction`ì´ 0ì´ ë˜ì—ˆì„ ë•Œ `flush()` í•¨ìˆ˜ê°€ í˜¸ì¶œë©ë‹ˆë‹¤.

### flush()

```ts:notifyManager.flush() showLineNumbers {2,5}
const flush = (): void => {
  const originalQueue = queue;
  queue = [];
  if (originalQueue.length) {
    scheduleMicrotask(() => {
      batchNotifyFn(() => {
        originalQueue.forEach((callback) => {
          notifyFn(callback);
        });
      });
    });
  }
};
```

5ë²ˆ ë¼ì¸ì˜ `scheduleMicrotask()`ëŠ” ìµìˆ™í•˜ì£ ? [ìœ„ì—ì„œ](#batchcalls) ì´ë¯¸ ë´¤ìœ¼ë‹ˆê¹Œìš”. ë¦¬ë Œë”ë§ì´ ìµœëŒ€í•œ í•œë²ˆì— ì¼ì–´ë‚˜ë„ë¡ `callback` í•¨ìˆ˜ë“¤ì„ íƒœìŠ¤í¬ íì— ë„£ì–´ì¤ë‹ˆë‹¤. í˜„ì¬ í˜¸ì¶œ ìŠ¤íƒì— ìŒ“ì—¬ìˆëŠ” ë™ì‘ì´ ëª¨ë‘ ìˆ˜í–‰ë˜ë©´ ë¦¬ë Œë”ë§ì´ ë°œìƒí•˜ê³ , Component1ê³¼ Component2ëŠ” ë°”ë€ `result`ë¥¼ `useQuery()`ë¡œë¶€í„° return ë°›ì•„ ë¦¬ë Œë”ë§í•˜ê²Œ ë  ê²ƒì…ë‹ˆë‹¤.

## ë§ˆì¹˜ë©°

ì—¬íƒœê¹Œì§€ ì‘ì„±í•œ [ë™ì‘ì›ë¦¬ ì‹œë¦¬ì¦ˆ](https://www.timegambit.com/series/digging) ì¤‘ ë¶„ì„ê³¼ í¬ìŠ¤íŠ¸ ì‘ì„± ë“± ëª¨ë“  ë°©ë©´ìœ¼ë¡œ ê°€ì¥ ì–´ë µê³  ì˜¤ë˜ê±¸ë ¸ìŠµë‹ˆë‹¤. ì‹¤ì œ í¬ìŠ¤íŠ¸ ë¶„ëŸ‰ë„ ê°€ì¥ ë§ë„¤ìš”. ì´ ë¶„ì„ì„ í•˜ë©´ì„œ ê°€ì¥ ë§ì´ ë°°ìš´ ì ì€ ì„¤ê³„ì…ë‹ˆë‹¤. ì˜ˆì „ì— ìš°ì•„í•œ í…Œí¬ìº í”„ë¥¼ í•˜ë©´ì„œ ì„¤ê³„ì˜ ì¤‘ìš”ì„±ì„ ì•Œê³  ìˆì—ˆëŠ”ë°, ë‹¤ì‹œ í•œë²ˆ ì¤‘ìš”ì„±ì„ ëŠë¼ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŸ° ì„¤ê³„ë¥¼ ì–´ë µì§€ ì•Šê²Œ í•  ìˆ˜ ìˆëŠ” ì‹¤ë ¥ì´ ë  ë•Œê¹Œì§€ ë™ì‘ì›ë¦¬ ì‹œë¦¬ì¦ˆëŠ” ê³„ì†ë©ë‹ˆë‹¤!

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ìºì‹œì˜ ë§Œë£Œì— ëŒ€í•´ì„œ ë‹¤ë£¨ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

**ì˜¤íƒ€ ë° ì˜¤ë¥˜ ì§€ì ì€ ì–¸ì œë‚˜ í™˜ì˜ì…ë‹ˆë‹¤!**

[^ì´ë²¤íŠ¸ ë£¨í”„]: ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‹±ê¸€ìŠ¤ë ˆë“œ ê¸°ë°˜ ì–¸ì–´ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ setTimeout, Promiseì™€ ê°™ì´ ë¹„ë™ê¸° ê¸°ëŠ¥ì„ ì§€ì›í•˜ê¸° ìœ„í•´ [ì´ë²¤íŠ¸ ë£¨í”„](https://developer.mozilla.org/ko/docs/Web/JavaScript/EventLoop)ê°€ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ìˆ˜í–‰ë˜ì–´ì•¼ í•˜ëŠ” ë™ì‘ë“¤ì€ **í˜¸ì¶œ ìŠ¤íƒ**ì—, setTimeoutì´ë‚˜ Promiseì™€ ê°™ì´ ë¹„ë™ê¸° ë™ì‘ë“¤ì€ **íƒœìŠ¤í¬ í**ì— ë„£ì–´ì¤ë‹ˆë‹¤. í˜¸ì¶œ ìŠ¤íƒì— ìŒ“ì¸ ë™ì‘ë“¤ì´ ëª¨ë‘ ìˆ˜í–‰ë˜ì–´ í˜¸ì¶œ ìŠ¤íƒì´ ë¹„ì›Œì§€ë©´, ì´ë²¤íŠ¸ ë£¨í”„ê°€ íƒœìŠ¤í¬ íë¡œë¶€í„° í˜„ì¬ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ë™ì‘ë“¤ì„ ê°€ì ¸ì™€ í˜¸ì¶œ ìŠ¤íƒì— ë„£ì–´ì¤ë‹ˆë‹¤.



    `scheduleMicrotask()` í•¨ìˆ˜ëŠ” `setTimeout`ì— 0ì´ˆë¥¼ ì„¤ì •í•¨ìœ¼ë¡œì¨, í˜¸ì¶œ ìŠ¤íƒì— ìŒ“ì—¬ìˆëŠ” ëª¨ë“  ë™ì‘ì´ ì™„ë£Œëœ ì´í›„ì— ë¦¬ë Œë”ë§ì´ ë°”ë¡œ ì‹¤í–‰ë˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.