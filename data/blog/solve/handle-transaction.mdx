---
title: 'íŠ¸ëœì­ì…˜ ë‹¤ë£¨ê¸° (feat. NestJS, TypeORM)'
date: '2023-03-09'
lastmod: '2023-04-01'
tags: ['íŠ¸ëœì­ì…˜', 'NestJS', 'TypeORM']
draft: false
series: ë¬¸ì œì™€ í•´ê²°ì±…
summary: Nest JSì—ì„œ íŠ¸ëœì­ì…˜ì„ ì˜¬ë°”ë¥´ê²Œ ë‹¤ë£¨ê¸° ìœ„í•´ ê²ªì—ˆë˜ ê³ ë¯¼ê³¼ ë¬¸ì œì— ëŒ€í•œ í•´ê²°ë°©ë²•ì„ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.
images: ['https://i.imgur.com/C4XRx7e.png']
layout: PostLayout
---

## ì´ ê¸€ì„ ì“°ê²Œ ëœ ê³„ê¸°

í˜„ì¬ ì§„í–‰ ì¤‘ì¸ íŒ€í”„ë¡œì íŠ¸ì—ì„œ ë°±ì—”ë“œë¥¼ NestJSë¡œ ê°œë°œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ìˆœì¡°ë¡­ê²Œ ê°œë°œì„ í•˜ë˜ ì¤‘ íŠ¸ëœì­ì…˜ê³¼ ê´€ë ¨ëœ ë¡œì§ì„ ì–´ë””ì„œ ìˆ˜í–‰í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ì€ì§€ ì˜ê²¬ì¶©ëŒì´ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ì— ëŒ€í•œ ê³ ë¯¼ê³¼ í•´ê²°ë°©ë²•ì„ ì •ë¦¬í•˜ê¸° ìœ„í•´ ì´ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

### íŠ¸ëœì­ì…˜

ë³¸ê²©ì ìœ¼ë¡œ ì†Œê°œí•˜ê¸° ì „ì— íŠ¸ëœì­ì…˜ì´ ë¬´ì—‡ì¸ì§€ ê°„ë‹¨íˆ ì •ë¦¬í•˜ê² ìŠµë‹ˆë‹¤. íŠ¸ëœì­ì…˜ì´ë€ DBì˜ ìƒíƒœë¥¼ ë³€í™”ì‹œí‚¤ê¸° ìœ„í•´ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì—°ì‚°ë“¤ì˜ ì§‘í•©ìœ¼ë¡œ, ACIDë¼ëŠ” íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

#### Atomicity(ì›ìì„±)

íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ ì‘ì—…ìœ¼ë¡œ ë¬¶ì—¬ìˆê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ë‚´ë¶€ì˜ ëª¨ë“  ì—°ì‚°ë“¤ì€ ë°˜ë“œì‹œ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë§Œì•½ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì˜ ì—°ì‚° ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ íŠ¸ëœì­ì…˜ì€ ì·¨ì†Œë˜ê³  ì´ì „ ìƒíƒœë¡œ ë³µêµ¬ë©ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ ê³„ì¢Œ ì´ì²´ë¥¼ ìƒê°í•´ë´…ì‹œë‹¤. ê³„ì¢Œ ì´ì²´ë¥¼ ìœ„í•´ ì¶œê¸ˆê³¼ ì…ê¸ˆì´ë¼ëŠ” ë‘ ê°€ì§€ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì¶œê¸ˆ ì‘ì—…ì´ ì„±ê³µí•˜ê³  ì…ê¸ˆ ì‘ì—…ì´ ì‹¤íŒ¨í•œë‹¤ë©´, ì¶œê¸ˆë˜ê¸° ì´ì „ ìƒíƒœë¡œ ë³µêµ¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

#### Consistency(ì¼ê´€ì„±)

íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ DBëŠ” ì¼ê´€ì„± ìˆëŠ” ìƒíƒœë¡œ ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì¼ê´€ì„±ì´ë€ ë°ì´í„°ì— ëª¨ìˆœì´ ì—†ì–´ì•¼ í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ ì œ í†µì¥ì€ ë§ˆì´ë„ˆìŠ¤ë¥¼ í—ˆìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤. ë§Œì•½ í†µì¥ì— 1000ì›ì´ ìˆê³  2000ì›ì„ ì¶œê¸ˆí•˜ë ¤ê³  í•œë‹¤ë©´ í†µì¥ì—ëŠ” ë§ˆì´ë„ˆìŠ¤ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ëª¨ìˆœì„ ë°©ì§€í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ì€ ì¼ê´€ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

#### Isolation(ë…ë¦½ì„±)

íŠ¸ëœì­ì…˜ì„ ìˆ˜í–‰í•  ë•Œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì‘ì—…ì— ë¼ì–´ë“¤ì§€ ëª»í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. í˜„ì¬ ì‚¬ìš©í•˜ê³  ìˆëŠ” DBë¥¼ ë‚˜ í˜¼ìë§Œ ì“°ëŠ” ê²ƒì²˜ëŸ¼ ì°©ê°ì„ í•˜ê²Œ ë§Œë“¤ì–´ì£¼ëŠ” íŠ¹ì„±ì…ë‹ˆë‹¤.

#### Durability(ì§€ì†ì„±)

íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ê·¸ ê²°ê³¼ëŠ” ì˜êµ¬ì ìœ¼ë¡œ ë°˜ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë˜ê³  ë‚˜ë©´ ì‹œìŠ¤í…œì´ ê³ ì¥ë‚˜ë”ë¼ë„ íŠ¸ëœì­ì…˜ì˜ ê²°ê³¼ëŠ” ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë°ì´í„° ë² ì´ìŠ¤ì—ëŠ” ë¡œê·¸ë¥¼ ì´ìš©í•œ ë³µêµ¬ ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤.

## Controller, Service, Repository

íŒ€í”„ë¡œì íŠ¸ì—ì„œ ë°±ì—”ë“œë¥¼ [Nest JS](https://nestjs.com/)ë¼ëŠ” í”„ë ˆì„ì›Œí¬ë¡œ ê°œë°œí•˜ê³  ìˆìŠµë‹ˆë‹¤. Springì€ ë‹¤ë¤„ë³¸ì ë„ ì—†ê³ , í”„ë¡ íŠ¸ì—”ë“œë¥¼ ì£¼ë¡œ ì‘ì—…í•˜ì—¬ JavaScriptê°€ ìµìˆ™í•œ ì €ì™€ íŒ€ì›ë“¤ì€ ë°±ì—”ë“œë¥¼ ë§Œë“¤ê¸° ìœ„í•œ í”„ë ˆì„ì›Œí¬ë¡œ Expressì™€ Nest JS ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ììœ ë„ê°€ ë†’ì€ ExpressëŠ” íŒ€í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ê¸°ì—ëŠ” ì½”ë“œì˜ ì¼ê´€ì„±ì´ ë–¨ì–´ì§ˆ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ê³  íŒë‹¨í•˜ì—¬, ê·œì¹™ê³¼ ì œì•½ì´ ê°•í•œ Nest JSë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

Nest JSëŠ” Javaì˜ Springê³¼ ë¹„ìŠ·í•œ êµ¬ì¡°ë¥¼ ë„ê³  ìˆìŠµë‹ˆë‹¤. Controller, Service, Repository ê³„ì¸µì„ ë¶„ë¦¬í•˜ì—¬ ê°œë°œí•©ë‹ˆë‹¤. ControllerëŠ” apiì˜ í˜¸ì¶œê³¼ ì‘ë‹µ, ServiceëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, RepositoryëŠ” DB ì‘ì—…ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

![ëŒ€ì¶©ê·¸ë¦¼](https://i.imgur.com/QsdOQay.png,https://i.imgur.com/CfbJlXB.png)

* Controller: API ìš”ì²­ì„ ë°›ì•„ ì¿¼ë¦¬, íŒŒë¼ë¯¸í„° ë“±ì„ Serviceì—ê²Œ ë„˜ê²¨ì£¼ê³ , Serviceë¡œ ë¶€í„° ë°›ì€ ê²°ê³¼ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬í•˜ëŠ” ì—­í• 
* Service: Controllerë¡œ ë¶€í„° ë°›ì€ ë°ì´í„°ë¥¼ ì´ìš©í•´ Repositoryì—ê²Œ DB ì‘ì—…ì„ ìš”ì²­. Repositoryì˜ ì‘ë‹µì„ ì´ìš©í•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ê³  Controllerì—ê²Œ ê²°ê³¼ë¥¼ ì „ë‹¬í•˜ëŠ” ì—­í• 
* Repository: Serviceë¡œ ë¶€í„° DB ì‘ì—…ì„ ìš”ì²­ë°›ì•„ CRUDë¥¼ ìˆ˜í–‰í•˜ì—¬ ê²°ê³¼ë¥¼ Serviceì—ê²Œ ì „ë‹¬í•˜ëŠ” ì—­í• 

ê° ê³„ì¸µì€ ì„œë¡œê°€ ë¬´ìŠ¨ ì¼ì„ ì–´ë–»ê²Œ í•˜ëŠ”ì§€ ì•Œ í•„ìš” ì—†ì´ ì •í•´ì§„ ì…ë ¥ì— ë”°ë¼ ì •í•´ì§„ ì¶œë ¥ì„ ë‚´ë†“ìœ¼ë©´ ë©ë‹ˆë‹¤. Controllerì™€ RepositoryëŠ” Serviceì—ì„œ ì–´ë–¤ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ëŠ”ì§€ ëª°ë¼ë„ ë©ë‹ˆë‹¤. ServiceëŠ” Controllerê°€ ì–´ë–¤ APIë¥¼ ìš”ì²­ë°›ì•˜ëŠ”ì§€, Repositoryê°€ DB ì‘ì—…ì„ ì–´ë–»ê²Œ ìˆ˜í–‰í•˜ëŠ”ì§€ ëª°ë¼ë„ ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ ê° ê³„ì¸µì´ ì„œë¡œì˜ ë™ì‘ ë°©ë²•ì„ ëª¨ë¥´ë©°, ê°ì ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì´ ê°€ì¥ ë°”ëŒì§í•œ êµ¬ì¡°ì…ë‹ˆë‹¤.

## ë°œê²¬í•œ ë¬¸ì œì 

ë¬¸ì œëŠ” ì´ ë…ë¦½ì  ê³„ì¸µêµ¬ì¡°ë¥¼ ì§€í‚¤ê³ ìí•˜ëŠ” ê²ƒìœ¼ë¡œë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ì€ DB ë™ì‘ê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤. ì• ì´ˆì— íŠ¸ëœì­ì…˜ì€ DBì™€ ê´€ë ¨ëœ ê°œë…ì…ë‹ˆë‹¤. ë”°ë¼ì„œ Repositoryì—ì„œ ê´€ë¦¬í•´ì£¼ì–´ì•¼ í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ Repositoryì—ì„œ ì²˜ë¦¬í•˜ê¸°ì—ëŠ” ë‹¤ì†Œ ì–´ìƒ‰í•œ ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ í•œ ë²ˆì˜ api í˜¸ì¶œë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë™ì‘ì´ ìˆœì„œëŒ€ë¡œ ì¼ì–´ë‚˜ì•¼ í•œë‹¤ê³  ê°€ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.

1. A í…Œì´ë¸”ì— ìƒˆë¡œìš´ Recordë¥¼ Create
2. 1ë²ˆì´ ì„±ê³µí•˜ë©´ B í…Œì´ë¸”ì— Update
3. 2ë²ˆì´ ì„±ê³µí•˜ë©´ C í…Œì´ë¸”ì—ì„œ ê¸°ì¡´ Recordë¥¼ Delete

ì´ 3ê°œì˜ í–‰ë™ë“¤ì€ **íŠ¸ëœì­ì…˜**ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ì•¼í•˜ëŠ” **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**ì…ë‹ˆë‹¤. ì´ ì¼ë ¨ì˜ ë™ì‘ë“¤ì„ ë‹¤ë£¨ëŠ” ê²ƒì€ **íŠ¸ëœì­ì…˜ì„ ìƒê°í•œë‹¤ë©´ Repositoryì—ì„œ** ì´ë£¨ì–´ì ¸ì•¼ í•˜ë©°, **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìƒê°í•œë‹¤ë©´ Service**ì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤. ì´ 2ê°€ì§€ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. Repositoryì˜ 1, 2, 3ë²ˆ ë™ì‘ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ë¥¼ Serviceì—ì„œ ê°ê° í˜¸ì¶œí•˜ë˜, 1ë²ˆ í˜¸ì¶œ ì „ì— íŠ¸ëœì­ì…˜ì„ ì‹œì‘, 3ë²ˆ í˜¸ì¶œ í›„ì— íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ëŠ” ë°©ë²•
2. Repositoryì— 3ê°œì˜ ë™ì‘ì„ ëª¨ë‘ ìˆ˜í–‰í•˜ëŠ” í•˜ë‚˜ì˜ í•¨ìˆ˜ë¥¼ ë§Œë“¤ê³ , 1ë²ˆ ìˆ˜í–‰ ì „ì— íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë©° 3ë²ˆ ìˆ˜í–‰ í›„ì— íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.

```ts:ë°©ë²•1 {1,4,8}
class Service {
  ...
  async doSomething() {
    await queryRunner.startTransaction(); // íŠ¸ëœì­ì…˜ ì‹œì‘
    await this.repository.func1();
    await this.repository.func2();
    await this.repository.func3();
    await queryRunner.commitTransaction(); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
  }
  ...
}

class Repository {
  ...
  async func1() { ... }
  async func2() { ... }
  async func3() { ... }
  ...
}
```

```ts:ë°©ë²•2 {9,12,16}
class Service {
  ...
  async doSomething() {
    await this.repository.func();
  }
  ...
}

class Repository {
  ...
  async func() {
    await queryRunner.startTransaction(); // íŠ¸ëœì­ì…˜ ì‹œì‘
    await this.func1();
    await this.func2();
    await this.func3();
    await queryRunner.commitTransaction(); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
  }
  async func1() { ... }
  async func2() { ... }
  async func3() { ... }
  ...
}
```


íŠ¸ëœì­ì…˜ì€ DBì™€ ê´€ë ¨ëœ ì‘ì—…ì„ì—ë„ ë¶ˆêµ¬í•˜ê³ , **1ë²ˆ ë°©ë²•ì€ Serviceì—ì„œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬**í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë°˜ë©´ 2ë²ˆ ë°©ë²•ì€ ì˜¬ë°”ë¥´ê²Œ íŠ¸ëœì­ì…˜ì„ DBì™€ ê´€ë ¨ëœ ê³„ì¸µì¸ Repositoryì—ì„œ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ **2ë²ˆ ë°©ë²•ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ Respositoryì—ì„œ ìˆ˜í–‰**í•œë‹¤ëŠ” ë¬¸ì œì ì´ ìˆìŠµë‹ˆë‹¤. 1ë²ˆ, 2ë²ˆ, 3ë²ˆ ë™ì‘ì´ ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰ë˜ì–´ì•¼í•œë‹¤ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ê´€ë ¨ëœ ì½”ë“œê°€ Repositoryì— ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

## í•´ê²°ë°©ë²•

ì €ë¥¼ í¬í•¨í•œ ëª¨ë“  íŒ€ì›ë“¤ ëª¨ë‘ ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ê³ ë¥´ê¸°ì—ëŠ” ë‘˜ ë‹¤ ë„ˆë¬´ ë§ˆìŒì— ë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì–´ì©” ìˆ˜ ì—†ì´ ì •í•´ì•¼ í–ˆê¸°ì— í•œ íŒ€ì›ì€ Repositoryì—ì„œ, ì €ëŠ” Serviceì—ì„œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ìê³  ì£¼ì¥í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‹¤ ë¬¸ëœ© Java í”„ë ˆì„ì›Œí¬ì¸ Springì€ ì–´ë–»ê²Œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ”ì§€ ê¶ê¸ˆí•´ì¡ŒìŠµë‹ˆë‹¤.

```java:Spring-ì½”ë“œ
@Service
@RequiredArgsConstructor
@Transactional // íŠ¸ëœì­ì…˜ì„ ìœ„í•œ ë°ì½”ë ˆì´í„°
public class TmpService {
    ...
}
```

Springì—ì„œëŠ” `@Transactional` ë°ì½”ë ˆì´í„°ë¥¼ Serviceì— ì¶”ê°€í•˜ì—¬ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì€ íšê¸°ì ì´ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë§Œ ë†“ê³  ë³´ë©´ ì´ ë°©ë²• ë˜í•œ Serviceì—ì„œ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ë¯€ë¡œ 1ë²ˆ ë°©ë²•ê³¼ ë‹¤ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì§ì ‘ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë¥¼ ì‘ì„±í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— Serviceì—ì„œ ê´€ë¦¬í•œë‹¤ëŠ” ëŠë‚Œì´ ë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¬´ì—‡ë³´ë‹¤ ë„ˆë¬´ ê°„í¸í•´ë³´ì˜€ìŠµë‹ˆë‹¤.

### @Transactional ë§Œë“¤ê¸°

```ts:transaction.middleware.ts showLineNumbers {5-6,9,15-16}
@Injectable()
export class TransactionMiddleware implements NestMiddleware {
  constructor(private readonly em: EntityManager) {}
  use(_req: Request, _res: Response, next: NextFunction) {
    const namespace =
      getNamespace(PLANDAR_NAMESPACE) ?? createNamespace(PLANDAR_NAMESPACE);
    return namespace.runAndReturn(async () => {
      Promise.resolve()
        .then(() => this.setEntityManager())
        .then(next);
    });
  }

  private setEntityManager() {
    const namespace = getNamespace(PLANDAR_NAMESPACE) as Namespace;
    namespace.set<EntityManager>(PLANDAR_ENTITY_MANAGER, this.em);
  }
}
```

ìš°ì„  ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ìˆ˜í–‰ë˜ëŠ” `TransactionMiddleware`ë¥¼ ë§Œë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤. ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” `PLANDAR_NAMESPACE` namespaceë¥¼ ê°€ì ¸ì™€ì„œ(ì—†ë‹¤ë©´ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤) í˜„ì¬ì˜ Entity Managerë¥¼ ë“±ë¡ì‹œì¼œì¤ë‹ˆë‹¤.

```ts:transaction.decorator.ts showLineNumbers {10,12,14-17,27}
export function Transactional() {
  return function (
    _target: object,
    _propertyKey: string | symbol,
    descriptor: TypedPropertyDescriptor<any>,
  ) {
    const originMethod = descriptor.value;

    async function transactionWrapped(...args: unknown[]) {
      const nameSpace = getNamespace(PLANDAR_NAMESPACE);
      ...
      const em = nameSpace.get(PLANDAR_ENTITY_MANAGER) as EntityManager;
      ...
      return await em.transaction(async (tx: EntityManager) => {
        nameSpace.set<EntityManager>(PLANDAR_ENTITY_MANAGER, tx);
        return await originMethod.apply(this, args);
      });
    }
    descriptor.value = transactionWrapped;
  };
}

// ì‚¬ìš©
@Injectable()
class UserService {
  ...
  @Transactional()
  async getUsers() {
    return this.userRepo.find();
  }
  ...
}
```

ê·¸ë¦¬ê³  `@Transactional()`ì„ ë§Œë‚˜ë©´ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ë“±ë¡ëœ Entity Managerë¥¼ ê°€ì ¸ì™€ì„œ íƒ€ê²Ÿ í•¨ìˆ˜(ìœ„ ì½”ë“œì—ì„œëŠ” `getUsers()`)ë¥¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê°ì‹¸ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤(14~17 ë¼ì¸).

## ìƒˆë¡œìš´ ë‹ˆì¦ˆ(needs)

`@Transactinal()` ë°ì½”ë ˆì´í„°ë¥¼ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë”ë‹ˆ ì˜ ë™ì‘í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì €í¬ì—ê²ŒëŠ” ìƒˆë¡œìš´ ë‹ˆì¦ˆê°€ ìƒê²¼ìŠµë‹ˆë‹¤.

* TypeORM 0.3.0ë¶€í„° deprecatedëœ `EntityRepository`ì™€ ê°™ì€ ê¸°ëŠ¥
* TypeORMì´ ì œê³µí•˜ëŠ” í•¨ìˆ˜ ì¤‘ ê°„ë‹¨í•œ ê²ƒë“¤ì„ Service ê³„ì¸µì—ì„œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°

ì´ ë‹ˆì¦ˆë¥¼ ì¶©ì¡±ì‹œí‚¤ê¸° ìœ„í•´ `TransactionManager`ì™€ `RootRepository`ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

### TransactionManager

```ts:transaction.manager.ts
@Injectable()
export class TransactionManager {
  getEntityManager(): EntityManager {
    const nameSpace = getNamespace(PLANDAR_NAMESPACE);
    if (!nameSpace || !nameSpace.active)
      throw new InternalServerErrorException(
        `${PLANDAR_NAMESPACE} is not active`,
      );
    return nameSpace.get(PLANDAR_ENTITY_MANAGER);
  }
}
```

`TransactionManager`ëŠ” ê°„ë‹¨í•©ë‹ˆë‹¤. í™œì„±í™”ëœ `PLANDAR_NAMESPACE`ì— ë“±ë¡ë˜ì–´ ìˆëŠ” Entity Managerë¥¼ ê°€ì ¸ì˜¤ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

### RootRepository

```ts:root.repository.ts showLineNumbers {1,3,5}
export abstract class RootRepository<T> extends Repository<T> {
  constructor(
    @Inject(TransactionManager) private readonly txManager: TransactionManager,
  ) {
    super(RootRepository, txManager.getEntityManager());
  }

  abstract getName(): EntityTarget<T>;

  protected getRepo(): Repository<T> {
    return this.txManager.getEntityManager().getRepository(this.getName());
  }
}

// ì‚¬ìš©
export class UserRepository extends RootRepository<User> {
  getName(): EntityTarget<User> {
    return User.name;
  }
  async createUser(username: string) {
    return this.getRepo().insert({
      username,
    });
  }
}
```

3ë²ˆì§¸ ì¤„ì—ì„œ `TransactionManager`ë¡œë¶€í„° Entity Managerë¥¼ ì£¼ì…ë°›ì•„ `getRepo()` í•¨ìˆ˜ë¥¼ ì´ìš©í•´ Repositoryë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. ê·¸ë¦¬ê³  1ë²ˆ ë¼ì¸ì„ í†µí•´ `RootRepository`ì— TypeORMì˜ `Repository`ë¥¼ ìƒì†ì‹œì¼œì£¼ê³ , 5ë²ˆ ë¼ì¸ì—ì„œ `RootRepository`ì— í˜„ì¬ì˜ Entity Managerë¥¼ ê°€ì ¸ì™€ ë“±ë¡ì‹œì¼œì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ Serviceì—ì„œë„ TypeORMì˜ í•¨ìˆ˜ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì—ˆë‹¤ê³  **ìƒê°í–ˆìŠµë‹ˆë‹¤**.

![Serviceì—ì„œ TypeORM í•¨ìˆ˜ ì‚¬ìš©](https://i.imgur.com/VyneWUK.png)

ìœ„ ì‚¬ì§„ì—ì„œ ë³´ì‹œë‹¤ì‹œí”¼ Serviceì—ì„œ TypeORMì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìë™ì™„ì„±ì´ ë˜ê¸¸ë˜ ë‹ˆì¦ˆë¥¼ ì¶©ì¡±ì‹œì¼°ë‹¤ê³  ì°©ê°í–ˆìŠµë‹ˆë‹¤.

## í•˜ì§€ë§Œ ë°œìƒí•œ ì—ëŸ¬

![Serviceì—ì„œì˜ TypeORM í•¨ìˆ˜ ëŸ°íƒ€ì„ ì—ëŸ¬](https://i.imgur.com/jmuMT39.png)

ê·¸ëŸ°ë° ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤... JavaScriptë¥¼ ìì£¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ëŒë“¤ì€ ìì£¼ ë³¼ ìˆ˜ ìˆëŠ” *Cannot read properties of undefined* ì—ëŸ¬ì˜€ìŠµë‹ˆë‹¤.

### ì›ì¸ì€?

```ts:root.repository.ts showLineNumbers {1,5}
export abstract class RootRepository<T> extends Repository<T> {
  constructor(
    @Inject(TransactionManager) private readonly txManager: TransactionManager,
  ) {
    super(RootRepository, txManager.getEntityManager());
  }
  ...
}
```

ì›ì¸ì€ 1, 5ë²ˆ ë¼ì¸ì…ë‹ˆë‹¤. Serviceì—ì„œ TypeORMì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” TypeORMì— ì •ì˜ëœ `Repository`ë¥¼ ìƒì†ë°›ì•„ì•¼ë§Œ í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ìƒì†ë°›ìœ¼ë©´ `super()`ë¥¼ í†µí•´ `Repository`ì˜ ìƒì„±ìë¥¼ í˜¸ì¶œí•´ì•¼ë§Œ í•©ë‹ˆë‹¤.

ì €ëŠ” `txManager.getEntityManager()`ë¥¼ í†µí•´, í˜„ì¬ì˜ namespaceì— ë“±ë¡ëœ Entity Managerë¥¼ ê°€ì ¸ì˜¤ê³  `RootRepository`ì— ë“±ë¡ì‹œì¼œì£¼ì—ˆë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ namespaceì— Entity Managerê°€ ë“±ë¡ë˜ëŠ” ê²ƒì€ ë¯¸ë“¤ì›¨ì–´ì—ì„œ, ì¦‰ apiê°€ í˜¸ì¶œë  ë•Œ ë“±ë¡ì´ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ `RootRepository`ëŠ” Nest JSì˜ ì„œë²„ êµ¬ë™ ì´ˆê¸°ì— ìƒì„±ë©ë‹ˆë‹¤. ì„œë²„ êµ¬ë™ ì´ˆê¸°ì—ëŠ” ë‹¹ì—°íˆ Entity Managerê°€ namespaceì— ë“±ë¡ëœ ìƒíƒœê°€ ì•„ë‹ˆë¯€ë¡œ `txManager.getEntityManager()`ëŠ” undefinedë¥¼ ë°˜í™˜í•˜ê²Œ ë˜ê³ , `RootRepository`ì˜ Entity Managerì—ëŠ” undefinedê°€ ë“±ë¡ë˜ì–´ ë°œìƒí–ˆë˜ ê²ƒì…ë‹ˆë‹¤.

## typeorm-transactional

ì‚¬ì‹¤ ì—¬ê¸°ê¹Œì§€ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìŸì€ ì‹œê°„ì´ ë„ˆë¬´ ë§ì•˜ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ ìœ„í•œ ì‹œê°„ì€ í•œì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, í•´ê²°í•  ìˆ˜ ìˆì„ì§€ ì—†ì„ì§€ ëª¨ë¥´ëŠ” ë¬¸ì œë¥¼ ì§ì ‘ ì½”ë“œì ìœ¼ë¡œ í•´ê²°í•˜ê¸°ë³´ë‹¤ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì°¾ì•„ë³´ì•˜ìŠµë‹ˆë‹¤. ë‹¤í–‰íˆ [typeorm-transactional](https://www.npmjs.com/package/typeorm-transactional)ì´ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì†ŒìŠ¤ì½”ë“œ ë¶„ì„ ë° í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë¬¸ì œê°€ ì—†ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¼ëŠ” ê²ƒì„ í™•ì¸í•˜ì˜€ê³  ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í•˜ì˜€ìŠµë‹ˆë‹¤. ì¬ë¯¸ìˆì—ˆë˜ ì ì€ íŒ€ì› ì¤‘ í•œ ëª…ì´ ìœ„ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ `Object.defineProperty`ë¥¼ ì´ìš©í•œ ë°©ì‹ì„ pseudo codeë¡œ ì œì‹œí–ˆì—ˆëŠ”ë°, ì´ì™€ ìœ ì‚¬í•œ ì½”ë“œê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì— ì¡´ì¬í–ˆì—ˆìŠµë‹ˆë‹¤. ğŸ™ƒ

ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì†ŒìŠ¤ì½”ë“œ ë¶„ì„ì€ [í”„ë¡œì íŠ¸ ê¹ƒí—ˆë¸Œ Wiki](https://github.com/JiPyoTak/plandar-server/wiki/typeorm-transactional)ì— ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

## ë§ˆì¹˜ë©°

ì €ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìì§€ë§Œ ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•  ë•Œì—ëŠ” í”„ë¡ íŠ¸ì—”ë“œ, ë°±ì—”ë“œ í•  ê²ƒ ì—†ì´ í•­ìƒ ì¬ë¯¸ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì˜ˆì „ë¶€í„° Nest JSë¥¼ ì‚¬ìš©í•˜ë©° ê³ ë¯¼í–ˆë˜ ë¬¸ì œë¥¼ íŒ€ì›ê³¼ í•¨ê»˜ ë…¼ì˜í•˜ë©° í•´ê²°í•´ë‚˜ê°”ê¸° ë•Œë¬¸ì—, íŠ¹íˆ ë” ì¬ë°Œì—ˆë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
